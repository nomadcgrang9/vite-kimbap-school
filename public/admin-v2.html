<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ V2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .debug-log {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .error-log {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
        }
        .success-log {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-cog text-blue-500 mr-2"></i>
                ê´€ë¦¬ì í˜ì´ì§€ V2
            </h1>
            <div class="flex items-center space-x-4">
                <span id="currentTime" class="text-sm text-gray-600"></span>
                <button onclick="teacherLogout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-heartbeat text-green-500 mr-2"></i>
                ì‹œìŠ¤í…œ ìƒíƒœ
            </h2>
            <div id="systemStatus" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- ìƒíƒœ í‘œì‹œë  ê³³ -->
            </div>
        </div>

        <!-- Main Functions Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <!-- 1. í¬ì¸íŠ¸ ê´€ë¦¬ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    í¬ì¸íŠ¸ ê´€ë¦¬
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ì˜ í¬ì¸íŠ¸ í˜„í™©ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <button onclick="loadPointsModule()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>í¬ì¸íŠ¸ ê´€ë¦¬ ì—´ê¸°
                </button>
                <div id="pointsModuleStatus" class="mt-2 text-xs"></div>
            </div>

            <!-- 2. í•™ìƒ ê´€ë¦¬ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-users text-green-500 mr-2"></i>
                    í•™ìƒ ê´€ë¦¬
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ìƒ ë“±ë¡ í˜„í™©ê³¼ í•™ê¸‰ë³„ ëª…ë‹¨ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <button onclick="loadStudentsModule()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>í•™ìƒ ê´€ë¦¬ ì—´ê¸°
                </button>
                <div id="studentsModuleStatus" class="mt-2 text-xs"></div>
            </div>

            <!-- 3. ì—­í•  ë°°ì • -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-tasks text-purple-500 mr-2"></i>
                    ì—­í•  ë°°ì •
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ì—ê²Œ ì—­í• ê³¼ ë¯¸ì…˜ì„ ë°°ì •í•©ë‹ˆë‹¤.</p>
                <button onclick="window.location.href='role-management.html'" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>ì—­í•  ë°°ì • ì—´ê¸°
                </button>
                <div id="rolesModuleStatus" class="mt-2 text-xs"></div>
            </div>

            <!-- 4. ë‹¨ê³„ë³„ ë‚´ìš© ê´€ë¦¬ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-tasks text-orange-500 mr-2"></i>
                    ë‹¨ê³„ë³„ ë‚´ìš© ê´€ë¦¬
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ìƒí˜ì´ì§€ "ì˜¤ëŠ˜ì˜ í• ì¼"ì˜ ë‹¨ê³„ ì œëª©, ì„¤ëª…, ì•„ì´ì½˜ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
                <button onclick="openStageContentManager()" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600 transition">
                    <i class="fas fa-edit mr-2"></i>ë‹¨ê³„ë³„ ë‚´ìš© ìˆ˜ì •
                </button>
                <div id="stageContentStatus" class="mt-2 text-xs text-gray-500">
                    1ë‹¨ê³„, 2ë‹¨ê³„, 3ë‹¨ê³„ì˜ ì œëª©ê³¼ ì„¤ëª… ìˆ˜ì • ê°€ëŠ¥
                </div>
            </div>

            <!-- 5. í•™ìŠµ ì•ˆë‚´ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-book text-indigo-500 mr-2"></i>
                    í•™ìŠµ ì•ˆë‚´
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ë…„ë³„ í•™ìŠµ ì•ˆë‚´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                <button onclick="loadGuidesModule()" class="w-full bg-indigo-500 text-white py-2 rounded hover:bg-indigo-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>í•™ìŠµ ì•ˆë‚´ ì—´ê¸°
                </button>
                <div id="guidesModuleStatus" class="mt-2 text-xs"></div>
            </div>

            <!-- 6. ëŒë¦¼íŒ ê´€ë¦¬ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-dharmachakra text-yellow-500 mr-2"></i>
                    ëŒë¦¼íŒ ê´€ë¦¬
                </h3>
                <p class="text-sm text-gray-600 mb-4">ë©”ì¸í˜ì´ì§€ ëŒë¦¼íŒì— ì‚¬ìš©í•  ëª©ë¡ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <button onclick="loadSpinnerModule()" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>ëŒë¦¼íŒ ê´€ë¦¬ ì—´ê¸°
                </button>
                <div id="spinnerModuleStatus" class="mt-2 text-xs"></div>
            </div>

            <!-- 7. ì„ ìƒë‹˜ ë©”ì‹œì§€ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-envelope text-pink-500 mr-2"></i>
                    ì„ ìƒë‹˜ ë©”ì‹œì§€
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ì—ê²Œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
                <button onclick="loadMessagesModule()" class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>ë©”ì‹œì§€ ê´€ë¦¬ ì—´ê¸°
                </button>
                <div id="messagesModuleStatus" class="mt-2 text-xs"></div>
            </div>

            <!-- 8. ì˜¤ëŠ˜ì˜ ë½‘ê¸° ê´€ë¦¬ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-gift text-purple-500 mr-2"></i>
                    ì˜¤ëŠ˜ì˜ ë½‘ê¸° ê´€ë¦¬
                </h3>
                <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ì´ 2ë‹¨ê³„ ì™„ë£Œ ì‹œ ë°›ì„ ìˆ˜ ìˆëŠ” ë½‘ê¸° ë©”ì‹œì§€ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <button onclick="loadLuckyDrawModule()" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">
                    <i class="fas fa-arrow-right mr-2"></i>ë½‘ê¸° ê´€ë¦¬ ì—´ê¸°
                </button>
                <div id="luckyDrawModuleStatus" class="mt-2 text-xs"></div>
            </div>

        </div>

        <!-- Debug Console -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-terminal text-gray-600 mr-2"></i>
                ë””ë²„ê·¸ ì½˜ì†”
            </h3>
            <div id="debugConsole" class="max-h-64 overflow-y-auto">
                <div class="debug-log">ğŸš€ ì‹œìŠ¤í…œ ì‹œì‘...</div>
            </div>
            <button onclick="clearDebugConsole()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                <i class="fas fa-trash mr-2"></i>ì½˜ì†” ì§€ìš°ê¸°
            </button>
        </div>

    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Core Scripts -->
    <script>
        // ========== ë””ë²„ê·¸ ì‹œìŠ¤í…œ ==========
        const DEBUG = true; // ë””ë²„ê·¸ ëª¨ë“œ ì¼œê¸°
        
        function log(message, type = 'info') {
            if (!DEBUG) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
            
            console.log(`[${timestamp}] ${prefix} ${message}`);
            
            // í™”ë©´ì—ë„ í‘œì‹œ
            const debugConsole = document.getElementById('debugConsole');
            if (debugConsole) {
                const logDiv = document.createElement('div');
                logDiv.className = `debug-log ${type === 'error' ? 'error-log' : type === 'success' ? 'success-log' : ''}`;
                logDiv.textContent = `[${timestamp}] ${message}`;
                debugConsole.appendChild(logDiv);
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        }
        
        function clearDebugConsole() {
            const debugConsole = document.getElementById('debugConsole');
            if (debugConsole) {
                debugConsole.innerHTML = '<div class="debug-log">ğŸš€ ì½˜ì†” ì´ˆê¸°í™”ë¨</div>';
            }
        }

        // ========== ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ==========
        function checkSystemStatus() {
            log('ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ì‹œì‘');
            
            const statusContainer = document.getElementById('systemStatus');
            if (!statusContainer) return;
            
            const statuses = [
                { name: 'Supabase', check: (typeof globalSupabaseClient !== 'undefined' && globalSupabaseClient !== null) || (typeof supabase !== 'undefined' && supabase !== null), icon: 'ğŸ”—' },
                { name: 'Supabase API', check: typeof supabaseAPI !== 'undefined', icon: 'ğŸ”Œ' },
                { name: 'LocalStorage', check: typeof localStorage !== 'undefined', icon: 'ğŸ’¾' }
            ];
            
            statusContainer.innerHTML = statuses.map(status => `
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">${status.icon}</span>
                    <div>
                        <p class="text-sm font-semibold">${status.name}</p>
                        <p class="text-xs ${status.check ? 'text-green-600' : 'text-red-600'}">
                            ${status.check ? 'ì •ìƒ' : 'ë¯¸ì—°ê²°'}
                        </p>
                    </div>
                </div>
            `).join('');
            
            log(`ì‹œìŠ¤í…œ ì²´í¬ ì™„ë£Œ: ${statuses.filter(s => s.check).length}/${statuses.length} ì •ìƒ`, 'success');
            
            // Supabase í…Œì´ë¸” ì²´í¬
            checkSupabaseTables();
        }
        
        // Supabase í…Œì´ë¸” í™•ì¸
        async function checkSupabaseTables() {
            if (typeof supabaseAPI === 'undefined' || !globalSupabaseClient) {
                log('Supabase API ì‚¬ìš© ë¶ˆê°€ - í…Œì´ë¸” ì²´í¬ ê±´ë„ˆëœ€', 'error');
                return;
            }
            
            log('Supabase í…Œì´ë¸” ì²´í¬ ì‹œì‘');
            
            const tables = [
                'students',
                'daily_points',
                'point_history',
                'sessions',
                'assignments',
                'board_content'
            ];
            
            for (const table of tables) {
                try {
                    const { data, error } = await globalSupabaseClient
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        log(`âŒ í…Œì´ë¸” [${table}] ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`, 'error');
                    } else {
                        log(`âœ… í…Œì´ë¸” [${table}] ì ‘ê·¼ ê°€ëŠ¥`, 'success');
                    }
                } catch (e) {
                    log(`âŒ í…Œì´ë¸” [${table}] ì˜¤ë¥˜: ${e.message}`, 'error');
                }
            }
        }

        // ========== ëª¨ë“ˆ ë¡œë” ==========
        async function loadModule(moduleName, fileName, autoExecute = false) {
            try {
                log(`${moduleName} ëª¨ë“ˆ ë¡œë”© ì‹œì‘`);
                
                const statusDiv = document.getElementById(`${moduleName}ModuleStatus`);
                if (statusDiv) {
                    statusDiv.innerHTML = '<span class="text-blue-500">ë¡œë”© ì¤‘...</span>';
                }
                
                // ì´ë¯¸ ë¡œë“œëœ ìŠ¤í¬ë¦½íŠ¸ì¸ì§€ ì²´í¬
                const existingScript = document.querySelector(`script[src="static/admin-${fileName}.js"]`);
                if (existingScript) {
                    log(`${moduleName} ëª¨ë“ˆ ì´ë¯¸ ë¡œë“œë¨`);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span class="text-green-500">âœ… ë¡œë“œë¨</span>';
                    }
                    
                    // autoExecuteê°€ trueì¸ ê²½ìš°ì—ë§Œ ì‹¤í–‰
                    if (autoExecute) {
                        // ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•´ ì§ì ‘ í•¨ìˆ˜ í˜¸ì¶œ (loadModule ì¬ê·€ ë°©ì§€)
                        setTimeout(() => {
                            const functionName = `load${moduleName.charAt(0).toUpperCase() + moduleName.slice(1)}Module`;
                            const moduleFunction = window[functionName];
                            log(`${moduleName} ëª¨ë“ˆ í•¨ìˆ˜ ê²€ìƒ‰: ${functionName} = ${typeof moduleFunction}`);
                            
                            if (typeof moduleFunction === 'function') {
                                log(`${moduleName} ëª¨ë“ˆ ì‹¤í–‰ ì¤‘...`);
                                moduleFunction();
                            } else {
                                log(`${moduleName} ëª¨ë“ˆ ì‹¤í–‰ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${functionName}`, 'error');
                            }
                        }, 100);
                    }
                    return;
                }
                
                // ë™ì  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                const script = document.createElement('script');
                // ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ (2025-09-23 ìˆ˜ì •)
                const timestamp = Date.now();
                script.src = `static/admin-${fileName}.js?v=${timestamp}`;
                script.onload = () => {
                    log(`${moduleName} ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ`, 'success');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span class="text-green-500">âœ… ë¡œë“œë¨</span>';
                    }
                    
                    // autoExecuteê°€ trueë©´ ë¡œë“œ í›„ ë°”ë¡œ ì‹¤í–‰
                    if (autoExecute) {
                        setTimeout(() => {
                            const functionName = `load${moduleName.charAt(0).toUpperCase() + moduleName.slice(1)}Module`;
                            const executeFunction = window[functionName];
                            log(`${moduleName} ëª¨ë“ˆ í•¨ìˆ˜ ê²€ìƒ‰ (ì‹ ê·œë¡œë“œ): ${functionName} = ${typeof executeFunction}`);
                            
                            if (typeof executeFunction === 'function') {
                                log(`${moduleName} ëª¨ë“ˆ ìë™ ì‹¤í–‰`);
                                executeFunction();
                            } else {
                                log(`${moduleName} ëª¨ë“ˆ ì‹¤í–‰ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${functionName}`, 'error');
                            }
                        }, 100);
                    }
                };
                script.onerror = () => {
                    log(`${moduleName} ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨`, 'error');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span class="text-red-500">âŒ ë¡œë“œ ì‹¤íŒ¨</span>';
                    }
                };
                document.body.appendChild(script);
                
            } catch (error) {
                log(`${moduleName} ëª¨ë“ˆ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ëª¨ë“ˆ ë¡œë” í•¨ìˆ˜ë“¤ (ìë™ ì‹¤í–‰ í¬í•¨)
        async function loadPointsModule() {
            try {
                log('í¬ì¸íŠ¸ ê´€ë¦¬ ëª¨ë“ˆ ë¡œë”© ì‹œì‘');
                
                // ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                const existingScript = document.querySelector('script[src="static/admin-points.js"]');
                if (!existingScript) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'static/admin-points.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    console.log('[Admin] í¬ì¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                }
                
                // ì ì‹œ ëŒ€ê¸° í›„ ëª¨ë“ˆ í™•ì¸ ë° ì´ˆê¸°í™”
                await new Promise(resolve => setTimeout(resolve, 200));
                
                if (window.pointsModule && typeof window.pointsModule.initialize === 'function') {
                    console.log('[Admin] í¬ì¸íŠ¸ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹œì‘...');
                    await window.pointsModule.initialize();
                    console.log('[Admin] í¬ì¸íŠ¸ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ');
                    log('í¬ì¸íŠ¸ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                } else {
                    console.error('[Admin] í¬ì¸íŠ¸ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    log('í¬ì¸íŠ¸ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                }
                
                // UI í‘œì‹œ
                await showPointsInterface();
                
            } catch (error) {
                console.error('[Admin] í¬ì¸íŠ¸ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨:', error);
                log(`í¬ì¸íŠ¸ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        // ëª¨ë“  ëª¨ë“ˆ ë¡œë”© í•¨ìˆ˜ë“¤ ì •ì˜ (loadPointsModule, loadStudentsModuleëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
        // ğŸ”§ ì—­í• ë°°ì • ê´€ë¦¬ - ìƒˆ ì „ìš© í˜ì´ì§€ë¡œ ì´ë™ (ëª¨ë‹¬ ì°¨ë‹¨)
        function loadRolesModuleWrapper() { 
            try {
                console.log('ğŸš€ [FIXED] ì—­í• ë°°ì • ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...');
                
                // ê¸°ì¡´ ëª¨ë‹¬ì´ë‚˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì™„ì „ ì œê±°
                const existingModals = document.querySelectorAll('[id*="rolesModal"], [id*="roleModal"], .modal, .modal-backdrop');
                existingModals.forEach(modal => {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                });
                
                // ì „ì—­ í•¨ìˆ˜ ë®ì–´ì“°ê¸° ë°©ì§€
                if (window.loadRolesModuleWithUI) {
                    delete window.loadRolesModuleWithUI;
                }
                
                const statusDiv = document.getElementById('rolesModuleStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span class="text-blue-500">ğŸ“„ ìƒˆ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...</span>';
                }
                
                // ê°•ì œë¡œ ìƒˆ í˜ì´ì§€ë¡œ ì´ë™ (ëª¨ë‹¬ ì°¨ë‹¨)
                console.log('ğŸ”„ Redirecting to role-management.html...');
                setTimeout(() => {
                    window.location.href = 'role-management.html';
                }, 100);
                
            } catch (error) {
                console.error('ğŸš¨ [FIXED] ì—­í• ë°°ì • ì´ë™ ì˜¤ë¥˜:', error);
                log(`ì—­í• ë°°ì • ì´ë™ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        function loadStagesModule() { loadModule('stages', 'stages', true); }
        function loadGuidesModule() { loadModule('guides', 'guides', true); }
        function loadSpinnerModule() { loadModule('spinner', 'spinner', true); }
        async function loadMessagesModule() { 
            try {
                log('ë©”ì‹œì§€ ëª¨ë“ˆ ë¡œë”© ì‹œì‘');
                
                // ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                const existingScript = document.querySelector('script[src="static/admin-messages.js"]');
                if (!existingScript) {
                    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'static/admin-messages.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    console.log('[Admin] ë©”ì‹œì§€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                }
                
                // ì ì‹œ ëŒ€ê¸° í›„ ëª¨ë“ˆ í™•ì¸ ë° ì´ˆê¸°í™”
                await new Promise(resolve => setTimeout(resolve, 200));
                
                if (window.messagesModule && typeof window.messagesModule.initialize === 'function') {
                    console.log('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹œì‘...');
                    await window.messagesModule.initialize();
                    console.log('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ');
                    log('ë©”ì‹œì§€ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                } else {
                    console.error('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    log('ë©”ì‹œì§€ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                }
                
                // UI í‘œì‹œ
                await showMessagesInterface();
                
            } catch (error) {
                console.error('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨:', error);
                log(`ë©”ì‹œì§€ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆ ë¡œë”© í•¨ìˆ˜
        async function loadLuckyDrawModule() { 
            try {
                log('ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆ ë¡œë”© ì‹œì‘');
                
                // ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                const existingScript = document.querySelector('script[src="static/admin-lucky-draw.js"]');
                if (!existingScript) {
                    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'static/admin-lucky-draw.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    console.log('[Admin] ë½‘ê¸° ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                }
                
                // ì ì‹œ ëŒ€ê¸° í›„ ëª¨ë“ˆ í™•ì¸ ë° ì´ˆê¸°í™”
                await new Promise(resolve => setTimeout(resolve, 200));
                
                if (typeof loadLuckyDrawModule !== 'undefined') {
                    console.log('[Admin] ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆ í•¨ìˆ˜ í™•ì¸ë¨');
                    log('ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆ ë¡œë”© ì™„ë£Œ', 'success');
                } else {
                    console.error('[Admin] ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    log('ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                }
                
            } catch (error) {
                console.error('[Admin] ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨:', error);
                log(`ë½‘ê¸° ê´€ë¦¬ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë©”ì‹œì§€ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ í•¨ìˆ˜ (ë¹„ë™ê¸°)
        async function showMessagesInterface() {
            const modalContainer = document.getElementById('modalContainer');
            
            modalContainer.innerHTML = `
                <!-- ë©”ì‹œì§€ ì „ì†¡ ëª¨ë‹¬ -->
                <div id="messagesModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto m-4">
                        <!-- í—¤ë” -->
                        <div class="bg-pink-500 text-white p-6 rounded-t-lg">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold">
                                    <i class="fas fa-envelope mr-3"></i>ì„ ìƒë‹˜ ë©”ì‹œì§€ ì „ì†¡
                                </h2>
                                <button onclick="closeMessagesModal()" class="text-white hover:text-gray-200 transition">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <p class="mt-2 text-pink-100">í•™ìƒë“¤ì—ê²Œ ê°œë³„, í•™ê¸‰ë³„, ë˜ëŠ” ì „ì²´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ë©”ì¸ ì»¨í…ì¸  -->
                        <div class="p-6">
                            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                            <div class="flex mb-6 border-b">
                                <button id="individualTab" onclick="switchMessageTab('individual')" class="px-4 py-2 font-semibold text-pink-500 border-b-2 border-pink-500">
                                    <i class="fas fa-user mr-2"></i>ê°œë³„ ì „ì†¡
                                </button>
                                <button id="classTab" onclick="switchMessageTab('class')" class="px-4 py-2 font-semibold text-gray-500 hover:text-pink-500 transition ml-4">
                                    <i class="fas fa-users mr-2"></i>í•™ê¸‰ë³„ ì „ì†¡
                                </button>
                                <button id="allTab" onclick="switchMessageTab('all')" class="px-4 py-2 font-semibold text-gray-500 hover:text-pink-500 transition ml-4">
                                    <i class="fas fa-broadcast-tower mr-2"></i>ì „ì²´ ì „ì†¡
                                </button>
                                <button id="repliesTab" onclick="switchMessageTab('replies')" class="px-4 py-2 font-semibold text-gray-500 hover:text-pink-500 transition ml-4">
                                    <i class="fas fa-reply mr-2"></i>ë‹µì¥í™•ì¸
                                </button>
                            </div>

                            <!-- ê°œë³„ ì „ì†¡ -->
                            <div id="individualContent" class="tab-content">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-blue-700 mb-3">
                                        <i class="fas fa-user text-blue-500 mr-2"></i>ê°œë³„ í•™ìƒì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                                    </h3>
                                    
                                    <!-- ë‹¨ê³„ì  ì„ íƒ UI -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <!-- 1ë‹¨ê³„: í•™ë…„ ì„ íƒ -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-graduation-cap text-blue-500 mr-1"></i>1ë‹¨ê³„: í•™ë…„ ì„ íƒ
                                            </label>
                                            <select id="individualGradeSelect" 
                                                    onchange="updateIndividualClassOptions()" 
                                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                                <option value="1">1í•™ë…„</option>
                                                <option value="2">2í•™ë…„</option>
                                                <option value="3">3í•™ë…„</option>
                                                <option value="4">4í•™ë…„</option>
                                                <option value="5">5í•™ë…„</option>
                                                <option value="6">6í•™ë…„</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 2ë‹¨ê³„: í•™ê¸‰ ì„ íƒ -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-users text-green-500 mr-1"></i>2ë‹¨ê³„: í•™ê¸‰ ì„ íƒ
                                            </label>
                                            <select id="individualClassSelect" 
                                                    onchange="updateIndividualStudentOptions()" 
                                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                                    disabled>
                                                <option value="">ë¨¼ì € í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 3ë‹¨ê³„: í•™ìƒ ì„ íƒ -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-user text-purple-500 mr-1"></i>3ë‹¨ê³„: í•™ìƒ ì„ íƒ
                                            </label>
                                            <select id="individualStudentSelect" 
                                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                                                    disabled>
                                                <option value="">ë¨¼ì € í•™ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- ì„ íƒëœ í•™ìƒ ì •ë³´ í‘œì‹œ -->
                                    <div id="selectedStudentInfo" class="hidden mb-4 p-3 bg-white border border-blue-200 rounded-lg">
                                        <div class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span class="font-medium text-gray-700">ì„ íƒëœ í•™ìƒ:</span>
                                            <span id="selectedStudentName" class="ml-2 font-semibold text-blue-600"></span>
                                            <span id="selectedStudentClass" class="ml-2 text-sm text-gray-500"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€ ë‚´ìš©</label>
                                        <textarea id="individualMessage" rows="4" placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 resize-none"></textarea>
                                    </div>
                                    
                                    <button onclick="messagesModule.sendIndividual()" class="w-full bg-pink-500 text-white py-3 px-6 rounded-lg hover:bg-pink-600 transition font-semibold">
                                        <i class="fas fa-paper-plane mr-2"></i>ê°œë³„ ë©”ì‹œì§€ ì „ì†¡
                                    </button>
                                    
                                    <div id="individualSendStatus" class="mt-2 text-xs"></div>
                                </div>
                            </div>

                            <!-- í•™ê¸‰ë³„ ì „ì†¡ -->
                            <div id="classContent" class="tab-content hidden">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-green-700 mb-3">
                                        <i class="fas fa-users text-green-500 mr-2"></i>í•™ê¸‰ë³„ ì¼ê´„ ë©”ì‹œì§€ ì „ì†¡
                                    </h3>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">í•™ê¸‰ ì„ íƒ</label>
                                        <select id="classSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                                            <option value="">í•™ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€ ë‚´ìš©</label>
                                        <textarea id="classMessage" rows="4" placeholder="í•™ê¸‰ ì „ì²´ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 resize-none"></textarea>
                                    </div>
                                    
                                    <button onclick="messagesModule.sendClass()" class="w-full bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition font-semibold">
                                        <i class="fas fa-users mr-2"></i>í•™ê¸‰ë³„ ë©”ì‹œì§€ ì „ì†¡
                                    </button>
                                    
                                    <div id="classSendStatus" class="mt-2 text-xs"></div>
                                </div>
                            </div>

                            <!-- ì „ì²´ ì „ì†¡ -->
                            <div id="allContent" class="tab-content hidden">
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-purple-700 mb-3">
                                        <i class="fas fa-broadcast-tower text-purple-500 mr-2"></i>ì „ì²´ í•™ìƒ ì¼ê´„ ë©”ì‹œì§€ ì „ì†¡
                                    </h3>
                                    
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                                        <div class="flex items-center">
                                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                            <span class="text-sm text-yellow-700">
                                                ì „ì²´ <span id="totalStudentsCount" class="font-bold">0</span>ëª…ì˜ í•™ìƒì—ê²Œ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€ ë‚´ìš©</label>
                                        <textarea id="allStudentsMessage" rows="4" placeholder="ì „ì²´ í•™ìƒì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 resize-none"></textarea>
                                    </div>
                                    
                                    <button onclick="messagesModule.sendAllStudents()" class="w-full bg-purple-500 text-white py-3 px-6 rounded-lg hover:bg-purple-600 transition font-semibold">
                                        <i class="fas fa-broadcast-tower mr-2"></i>ì „ì²´ í•™ìƒì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                                    </button>
                                    
                                    <div id="allStudentsSendStatus" class="mt-2 text-xs"></div>
                                </div>
                            </div>

                            <!-- ë‹µì¥ í™•ì¸ -->
                            <div id="repliesContent" class="tab-content hidden">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-blue-700 mb-3">
                                        <i class="fas fa-reply text-blue-500 mr-2"></i>í•™ìƒ ë‹µì¥ í™•ì¸
                                    </h3>
                                    <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ì´ ë³´ë‚¸ ë‹µì¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                    
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="text-sm">
                                            ì´ <span id="repliesCount" class="font-bold text-blue-600">0</span>ê°œì˜ ë‹µì¥
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="loadStudentReplies()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm">
                                                <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                                            </button>
                                            <!-- ì•ˆì „í•œ ì¼ê´„ì‚­ì œ ë²„íŠ¼ (ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€) -->
                                            <button id="safeDeleteAllBtn" onclick="safeDeleteAllConversations(event)" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm">
                                                <i class="fas fa-trash-alt mr-1"></i>ëŒ€í™” ì¼ê´„ì‚­ì œ
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ë‹µì¥ ëª©ë¡ -->
                                    <div id="repliesList" class="space-y-3 max-h-96 overflow-y-auto">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p>ë‹µì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                        </div>
                                    </div>
                                    
                                    <div id="repliesStatus" class="mt-4 text-xs text-center"></div>
                                </div>
                            </div>
                        </div>

                        <!-- í‘¸í„° -->
                        <div class="bg-gray-50 px-6 py-4 rounded-b-lg">
                            <div class="flex justify-between items-center">
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ì „ì†¡ëœ ë©”ì‹œì§€ëŠ” í•™ìƒí˜ì´ì§€ ì„ ìƒë‹˜ìª½ì§€í•¨ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                                </div>
                                <button onclick="messagesModule.refreshStudents()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                                    <i class="fas fa-sync-alt mr-2"></i>í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // DOMì´ ì™„ì „íˆ ìƒì„±ëœ í›„ ì ì‹œ ëŒ€ê¸°
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // ëª¨ë“ˆì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (window.messagesModule && window.messagesModule.currentStudents) {
                console.log('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìŒ');
                log(`ë©”ì‹œì§€ ëª¨ë“ˆ ì¤€ë¹„ ì™„ë£Œ - í•™ìƒ ìˆ˜: ${window.messagesModule.currentStudents.length}ëª…`, 'success');
            } else if (window.messagesModule) {
                console.log('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆ ë°œê²¬, ì¬ì´ˆê¸°í™” ì‹œë„...');
                try {
                    await window.messagesModule.initialize();
                    console.log('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆ ì¬ì´ˆê¸°í™” ì™„ë£Œ');
                    log('ë©”ì‹œì§€ ëª¨ë“ˆ ì¬ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                } catch (error) {
                    console.error('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆ ì¬ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    log(`ë©”ì‹œì§€ ëª¨ë“ˆ ì¬ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            } else {
                console.error('[Admin] ë©”ì‹œì§€ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                log('ë©”ì‹œì§€ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
            }
        }

        // ë©”ì‹œì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeMessagesModal() {
            const modal = document.getElementById('messagesModal');
            if (modal) {
                modal.remove();
            }
        }

        // í¬ì¸íŠ¸ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ í•¨ìˆ˜
        async function showPointsInterface() {
            const modalContainer = document.getElementById('modalContainer');
            
            modalContainer.innerHTML = `
                <!-- í¬ì¸íŠ¸ ê´€ë¦¬ ëª¨ë‹¬ -->
                <div id="pointsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-screen overflow-y-auto m-4">
                        <!-- í—¤ë” -->
                        <div class="bg-blue-500 text-white p-6 rounded-t-lg">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold">
                                    <i class="fas fa-coins mr-3"></i>í¬ì¸íŠ¸ ê´€ë¦¬
                                </h2>
                                <button onclick="closePointsModal()" class="text-white hover:text-gray-200 transition">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <p class="mt-2 text-blue-100">í•™ìƒë“¤ì˜ í¬ì¸íŠ¸ í˜„í™©ì„ í™•ì¸í•˜ê³  í¬ì¸íŠ¸ë¥¼ ì§€ê¸‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ë©”ì¸ ì»¨í…ì¸  -->
                        <div class="p-6">
                            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                            <div class="flex space-x-1 mb-6 border-b">
                                <button id="pointsManagementTab" onclick="switchPointsTab('management')" class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">
                                    <i class="fas fa-users mr-2"></i>í¬ì¸íŠ¸ í˜„í™©
                                </button>
                                <button id="classGoalsTab" onclick="switchPointsTab('goals')" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-trophy mr-2"></i>í•™ê¸‰ ëª©í‘œ ì„¤ì •
                                </button>
                            </div>

                            <!-- í¬ì¸íŠ¸ í˜„í™© íƒ­ ë‚´ìš© -->
                            <div id="pointsManagementContent">
                            <!-- ìƒë‹¨ í†µê³„ ë° ì»¨íŠ¸ë¡¤ -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                    <i class="fas fa-users text-2xl text-blue-500 mb-2"></i>
                                    <div class="text-sm text-gray-600">ì ‘ì†í•œ í•™ìƒ</div>
                                    <div class="text-2xl font-bold text-blue-600" id="totalPointsCount">0</div>
                                </div>
                                
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                    <i class="fas fa-sync-alt text-2xl text-green-500 mb-2"></i>
                                    <div class="text-sm text-gray-600 mb-2">ìë™ ìƒˆë¡œê³ ì¹¨</div>
                                    <button onclick="window.pointsModule.loadAllStudentPoints()" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600 transition">
                                        <i class="fas fa-refresh mr-1"></i>ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </div>
                                
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                    <i class="fas fa-trash-alt text-2xl text-red-500 mb-2"></i>
                                    <div class="text-sm text-gray-600 mb-2">í¬ì¸íŠ¸ ì´ˆê¸°í™”</div>
                                    <button onclick="window.pointsModule.resetAllPoints()" class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600 transition">
                                        <i class="fas fa-redo mr-1"></i>ì „ì²´ ë¦¬ì…‹
                                    </button>
                                </div>
                            </div>

                            <!-- í•™ìƒ í¬ì¸íŠ¸ ëª©ë¡ -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">
                                        <i class="fas fa-list mr-2"></i>í•™ìƒ í¬ì¸íŠ¸ í˜„í™©
                                    </h3>
                                    <div class="text-sm text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
                                    </div>
                                </div>
                                
                                <div id="studentPointsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>í¬ì¸íŠ¸ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- í¬ì¸íŠ¸ ì§€ê¸‰ ì˜ì—­ -->
                            <div id="givePointSection" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-green-800">
                                        <i class="fas fa-plus mr-2"></i>í¬ì¸íŠ¸ ì§€ê¸‰
                                    </h3>
                                    <button onclick="closeGivePointSection()" class="text-green-600 hover:text-green-800">
                                        <i class="fas fa-times text-lg"></i>
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„ íƒëœ í•™ìƒ</label>
                                        <div class="text-lg font-semibold text-blue-600" id="selectedStudentName">-</div>
                                        <input type="hidden" id="selectedStudentId">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ì§€ê¸‰í•  í¬ì¸íŠ¸</label>
                                        <input type="number" id="pointsToGive" min="1" max="10" value="1" 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                    
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ì§€ê¸‰ ì‚¬ìœ </label>
                                        <input type="text" id="pointMessage" placeholder="ì˜ˆ: ìˆ˜ì—… ì°¸ì—¬ ìš°ìˆ˜, ê³¼ì œ ì™„ë£Œ ë“±" 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <div id="givePointStatus" class="text-sm"></div>
                                    
                                    <div class="flex space-x-3">
                                        <button onclick="closeGivePointSection()" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 transition">
                                            ì·¨ì†Œ
                                        </button>
                                        <button onclick="executeGivePointFromSection()" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition">
                                            <i class="fas fa-check mr-1"></i>ì§€ê¸‰í•˜ê¸°
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ìƒíƒœ ë©”ì‹œì§€ -->
                            <div id="pointsStatus" class="text-center text-sm"></div>
                            </div>

                            <!-- í•™ê¸‰ ëª©í‘œ ì„¤ì • íƒ­ ë‚´ìš© -->
                            <div id="classGoalsContent" style="display: none;">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                    <div class="flex items-center">
                                        <i class="fas fa-trophy text-2xl text-yellow-500 mr-3"></i>
                                        <div>
                                            <h3 class="text-lg font-semibold text-yellow-800">í•™ê¸‰ë³„ ìš°ë¦¬ë°˜ í¬ì¸íŠ¸ ëª©í‘œ ì„¤ì •</h3>
                                            <p class="text-sm text-yellow-700">ê° í•™ê¸‰ì˜ ê²Œì´ì§€ë°” ë§Œì ê°’ì„ ì„¤ì •í•˜ì—¬ í¬ì¸íŠ¸ ì¸í”Œë ˆì´ì…˜ì— ëŒ€ì‘í•˜ì„¸ìš”.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- í•™ê¸‰ ëª©í‘œ ì„¤ì • ë¦¬ìŠ¤íŠ¸ -->
                                <div class="space-y-4">
                                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-4">
                                            <h4 class="text-lg font-semibold text-gray-800">
                                                <i class="fas fa-school mr-2 text-blue-500"></i>í•™ê¸‰ë³„ ëª©í‘œ í¬ì¸íŠ¸
                                            </h4>
                                            <button onclick="loadClassGoals()" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition">
                                                <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                                            </button>
                                        </div>

                                        <!-- í•™ê¸‰ ëª©í‘œ ëª©ë¡ -->
                                        <div id="classGoalsList" class="space-y-3">
                                            <div class="text-center text-gray-500 py-4">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>í•™ê¸‰ ëª©í‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                            </div>
                                        </div>

                                        <!-- ìƒˆ í•™ê¸‰ ì¶”ê°€ -->
                                        <div class="mt-6 pt-4 border-t border-gray-200">
                                            <h5 class="font-medium text-gray-800 mb-3">ìƒˆ í•™ê¸‰ ëª©í‘œ ì¶”ê°€</h5>
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">í•™ê¸‰ëª…</label>
                                                    <input type="text" id="newClassName" placeholder="ì˜ˆ: 3-1" 
                                                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">ëª©í‘œ í¬ì¸íŠ¸</label>
                                                    <input type="number" id="newClassGoal" min="10" max="1000" value="200" 
                                                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                </div>
                                                <div class="flex items-end">
                                                    <button onclick="addNewClassGoal()" class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition">
                                                        <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ìƒíƒœ ë©”ì‹œì§€ -->
                                <div id="classGoalsStatus" class="text-center text-sm mt-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // DOMì´ ì™„ì „íˆ ìƒì„±ëœ í›„ ì ì‹œ ëŒ€ê¸°
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // ëª¨ë“ˆì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (window.pointsModule) {
                console.log('[Admin] í¬ì¸íŠ¸ ëª¨ë“ˆì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìŒ');
                log('í¬ì¸íŠ¸ ëª¨ë“ˆ ì¤€ë¹„ ì™„ë£Œ', 'success');
            } else {
                console.error('[Admin] í¬ì¸íŠ¸ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                log('í¬ì¸íŠ¸ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
            }
        }

        // í¬ì¸íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePointsModal() {
            const modal = document.getElementById('pointsModal');
            if (modal) {
                modal.remove();
            }
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
            if (window.pointsModule) {
                window.pointsModule.stopRefresh();
            }
        }

        // í¬ì¸íŠ¸ ê´€ë¦¬ íƒ­ ì „í™˜
        function switchPointsTab(tabName) {
            // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const managementTab = document.getElementById('pointsManagementTab');
            const goalsTab = document.getElementById('classGoalsTab');
            const managementContent = document.getElementById('pointsManagementContent');
            const goalsContent = document.getElementById('classGoalsContent');

            if (tabName === 'management') {
                managementTab.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                goalsTab.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                managementContent.style.display = 'block';
                goalsContent.style.display = 'none';
            } else if (tabName === 'goals') {
                managementTab.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                goalsTab.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                managementContent.style.display = 'none';
                goalsContent.style.display = 'block';
                
                // í•™ê¸‰ ëª©í‘œ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ë°ì´í„° ë¡œë“œ
                loadClassGoals();
            }
        }

        // === í•™ê¸‰ ëª©í‘œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ===
        
        // í•™ê¸‰ ëª©í‘œ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
        async function loadClassGoals() {
            const statusEl = document.getElementById('classGoalsStatus');
            const listEl = document.getElementById('classGoalsList');
            
            try {
                statusEl.textContent = 'í•™ê¸‰ ëª©í‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                statusEl.className = 'text-center text-sm mt-4 text-blue-600';
                
                // class_point_goals í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì¡°íšŒ
                const response = await smartFetch('tables/class_point_goals');
                const result = await response.json();
                
                if (result.data && Array.isArray(result.data)) {
                    displayClassGoals(result.data);
                    statusEl.textContent = `${result.data.length}ê°œ í•™ê¸‰ ëª©í‘œ ë¡œë“œ ì™„ë£Œ`;
                    statusEl.className = 'text-center text-sm mt-4 text-green-600';
                } else {
                    throw new Error('Invalid data format');
                }
                
            } catch (error) {
                console.error('[ClassGoals] ë¡œë“œ ì˜¤ë¥˜:', error);
                listEl.innerHTML = '<div class="text-center text-red-500 py-4">í•™ê¸‰ ëª©í‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                statusEl.textContent = 'ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
            }
        }
        
        // í•™ê¸‰ ëª©í‘œ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function displayClassGoals(goals) {
            const listEl = document.getElementById('classGoalsList');
            
            if (goals.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        <i class="fas fa-inbox text-3xl mb-2"></i>
                        <p>ì„¤ì •ëœ í•™ê¸‰ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm">ì•„ë˜ì—ì„œ ìƒˆ í•™ê¸‰ ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }
            
            const goalsHtml = goals.map(goal => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded border">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-school text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${goal.class_name}</div>
                            <div class="text-sm text-gray-600">ëª©í‘œ: ${goal.max_points}í¬ì¸íŠ¸</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="goal_${goal.id}" value="${goal.max_points}" min="10" max="1000" 
                               class="w-20 border border-gray-300 rounded px-2 py-1 text-center text-sm">
                        <button onclick="updateClassGoal('${goal.id}', '${goal.class_name}')" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">
                            <i class="fas fa-save"></i>
                        </button>
                        <button onclick="deleteClassGoal('${goal.id}', '${goal.class_name}')" 
                                class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            listEl.innerHTML = goalsHtml;
        }
        
        // ìƒˆ í•™ê¸‰ ëª©í‘œ ì¶”ê°€
        async function addNewClassGoal() {
            const classNameEl = document.getElementById('newClassName');
            const classGoalEl = document.getElementById('newClassGoal');
            const statusEl = document.getElementById('classGoalsStatus');
            
            const className = classNameEl.value.trim();
            const maxPoints = parseInt(classGoalEl.value);
            
            if (!className) {
                statusEl.textContent = 'í•™ê¸‰ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
                return;
            }
            
            if (maxPoints < 10 || maxPoints > 1000) {
                statusEl.textContent = 'ëª©í‘œ í¬ì¸íŠ¸ëŠ” 10~1000 ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
                return;
            }
            
            try {
                statusEl.textContent = 'í•™ê¸‰ ëª©í‘œ ì¶”ê°€ ì¤‘...';
                statusEl.className = 'text-center text-sm mt-4 text-blue-600';
                
                const response = await smartFetch('tables/class_point_goals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        class_name: className,
                        max_points: maxPoints
                    })
                });
                
                if (response.ok) {
                    classNameEl.value = '';
                    classGoalEl.value = '200';
                    statusEl.textContent = `${className} í•™ê¸‰ ëª©í‘œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    statusEl.className = 'text-center text-sm mt-4 text-green-600';
                    
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadClassGoals();
                } else {
                    throw new Error('ì¶”ê°€ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('[ClassGoals] ì¶”ê°€ ì˜¤ë¥˜:', error);
                statusEl.textContent = 'í•™ê¸‰ ëª©í‘œ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message;
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
            }
        }
        
        // í•™ê¸‰ ëª©í‘œ ìˆ˜ì •
        async function updateClassGoal(goalId, className) {
            const inputEl = document.getElementById(`goal_${goalId}`);
            const statusEl = document.getElementById('classGoalsStatus');
            const maxPoints = parseInt(inputEl.value);
            
            if (maxPoints < 10 || maxPoints > 1000) {
                statusEl.textContent = 'ëª©í‘œ í¬ì¸íŠ¸ëŠ” 10~1000 ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
                return;
            }
            
            try {
                statusEl.textContent = 'ëª©í‘œ í¬ì¸íŠ¸ ìˆ˜ì • ì¤‘...';
                statusEl.className = 'text-center text-sm mt-4 text-blue-600';
                
                const response = await smartFetch(`tables/class_point_goals/${goalId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        class_name: className,
                        max_points: maxPoints
                    })
                });
                
                if (response.ok) {
                    statusEl.textContent = `${className} í•™ê¸‰ ëª©í‘œê°€ ${maxPoints}í¬ì¸íŠ¸ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    statusEl.className = 'text-center text-sm mt-4 text-green-600';
                } else {
                    throw new Error('ìˆ˜ì • ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('[ClassGoals] ìˆ˜ì • ì˜¤ë¥˜:', error);
                statusEl.textContent = 'ëª©í‘œ í¬ì¸íŠ¸ ìˆ˜ì • ì‹¤íŒ¨: ' + error.message;
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
            }
        }
        
        // í•™ê¸‰ ëª©í‘œ ì‚­ì œ
        async function deleteClassGoal(goalId, className) {
            if (!confirm(`${className} í•™ê¸‰ì˜ ëª©í‘œ ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            const statusEl = document.getElementById('classGoalsStatus');
            
            try {
                statusEl.textContent = 'í•™ê¸‰ ëª©í‘œ ì‚­ì œ ì¤‘...';
                statusEl.className = 'text-center text-sm mt-4 text-blue-600';
                
                const response = await smartFetch(`tables/class_point_goals/${goalId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    statusEl.textContent = `${className} í•™ê¸‰ ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    statusEl.className = 'text-center text-sm mt-4 text-green-600';
                    
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadClassGoals();
                } else {
                    throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('[ClassGoals] ì‚­ì œ ì˜¤ë¥˜:', error);
                statusEl.textContent = 'í•™ê¸‰ ëª©í‘œ ì‚­ì œ ì‹¤íŒ¨: ' + error.message;
                statusEl.className = 'text-center text-sm mt-4 text-red-600';
            }
        }

        // í¬ì¸íŠ¸ ì§€ê¸‰ ì„¹ì…˜ ê´€ë ¨ ì „ì—­ í•¨ìˆ˜ë“¤
        function openGivePointSection(studentId, studentName) {
            if (window.pointsModule && window.pointsModule.openGivePointSection) {
                window.pointsModule.openGivePointSection(studentId, studentName);
            }
        }
        
        function closeGivePointSection() {
            if (window.pointsModule && window.pointsModule.closeGivePointSection) {
                window.pointsModule.closeGivePointSection();
            }
        }
        
        function executeGivePointFromSection() {
            if (window.pointsModule && window.pointsModule.executeGivePointFromSection) {
                window.pointsModule.executeGivePointFromSection();
            }
        }





        // ë©”ì‹œì§€ íƒ­ ì „í™˜
        function switchMessageTab(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            ['individual', 'class', 'all', 'replies'].forEach(tab => {
                const tabButton = document.getElementById(tab + 'Tab');
                const tabContent = document.getElementById(tab + 'Content');
                
                if (tabButton) {
                    if (tab === tabName) {
                        tabButton.className = 'px-4 py-2 font-semibold text-pink-500 border-b-2 border-pink-500';
                    } else {
                        tabButton.className = 'px-4 py-2 font-semibold text-gray-500 hover:text-pink-500 transition ml-4';
                    }
                }
                
                if (tabContent) {
                    if (tab === tabName) {
                        tabContent.classList.remove('hidden');
                    } else {
                        tabContent.classList.add('hidden');
                    }
                }
            });
            
            // ë‹µì¥í™•ì¸ íƒ­ì´ ì„ íƒë˜ì—ˆì„ ë•Œ ë‹µì¥ ë¡œë“œ
            if (tabName === 'replies') {
                loadStudentReplies();
            }
        }

        // ========== ë‹µì¥ í™•ì¸ ê¸°ëŠ¥ ==========
        
        // í•™ìƒ ë‹µì¥ ë¡œë“œ
        async function loadStudentReplies() {
            const repliesCountElement = document.getElementById('repliesCount');
            const repliesList = document.getElementById('repliesList');
            const repliesStatus = document.getElementById('repliesStatus');
            
            if (!repliesList) return;
            
            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
repliesList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>ë‹µì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                `;
                
                // REST APIë¡œ ë‹µì¥ ë°ì´í„° ë¡œë“œ (smartFetch ì‚¬ìš©)
                console.log('[LoadReplies] smartFetchë¡œ ë‹µì¥ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
                const response = await smartFetch('tables/teacher_messages?limit=100&sort=sent_at');
                const data = await response.json();
                
                if (data && data.data) {
                    // í•™ìƒì´ ë³´ë‚¸ ë©”ì‹œì§€ë§Œ í•„í„°ë§ (ë‹µì¥)
                    const studentReplies = data.data.filter(message => 
                        message.sender_type === 'student'
                    ).sort((a, b) => new Date(b.sent_at) - new Date(a.sent_at)); // ìµœì‹ ìˆœ
                    
                    console.log(`[Replies] ì´ ${studentReplies.length}ê°œ ë‹µì¥ ë¡œë“œë¨`);
                    
                    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    if (repliesCount) {
                        repliesCountElement.textContent = studentReplies.length;
                    }
                    
                    // ë‹µì¥ ëª©ë¡ í‘œì‹œ
                    if (studentReplies.length === 0) {
        repliesList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-4"></i>
                                <p>í•™ìƒ ë‹µì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        `;
                    } else {
        repliesList.innerHTML = studentReplies.map(reply => {
                            const sentAt = new Date(reply.sent_at);
                            const timeAgo = formatTimeAgo(sentAt);
                            const isUnread = !reply.is_read;
                            
                            return `
                                <div class="border rounded-lg p-3 ${isUnread ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-white'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-center">
                                            <div class="w-6 h-6 rounded-full ${isUnread ? 'bg-blue-500' : 'bg-gray-400'} flex items-center justify-center mr-2">
                                                <i class="fas fa-user text-white text-xs"></i>
                                            </div>
                                            <div>
                                                <span class="font-medium text-sm">${reply.sender_name || 'í•™ìƒ'}</span>
                                                ${isUnread ? '<span class="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">ìƒˆë‹µì¥</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            ${timeAgo}
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gray-50 rounded p-2 mb-2">
                                        <div class="text-sm text-gray-700">${reply.message || 'ë‚´ìš© ì—†ìŒ'}</div>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                        <div>ID: ${reply.sender_id}</div>
                                        <div>${sentAt.toLocaleString('ko-KR')}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    showRepliesStatus('ë‹µì¥ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
                    
                } else {
                    throw new Error('ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('[Replies] ë‹µì¥ ë¡œë“œ ì‹¤íŒ¨:', error);
                
repliesList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>ë‹µì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <button onclick="loadStudentReplies()" class="mt-2 text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                `;
                
                showRepliesStatus(`ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ìƒëŒ€ ì‹œê°„ í¬ë§·
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
            if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
            if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
            if (diffDays < 7) return `${diffDays}ì¼ ì „`;
            return date.toLocaleDateString('ko-KR');
        }
        
        // ì•ˆì „í•œ ëŒ€í™” ì¼ê´„ ì‚­ì œ í•¨ìˆ˜ (ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€)
        async function safeDeleteAllConversations(event) {
            // ì´ë²¤íŠ¸ ì „íŒŒ ì™„ì „ ì°¨ë‹¨
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            
            console.log('[SafeDelete] ì•ˆì „í•œ ëŒ€í™” ì¼ê´„ì‚­ì œ ì‹œì‘');
            
            // í™•ì¸ ëŒ€í™”ìƒì
            const confirmMessage = 'ì •ë§ë¡œ ì„ íƒëœ í•™ìƒê³¼ì˜ ëª¨ë“  ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nâš ï¸ êµì‚¬ ë©”ì‹œì§€ì™€ í•™ìƒ ë‹µì¥ì´ ëª¨ë‘ ì˜êµ¬íˆ ì‚­ì œë©ë‹ˆë‹¤.';
            
            if (!confirm(confirmMessage)) {
                console.log('[SafeDelete] ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨');
                return;
            }
            
            const repliesContainer = document.getElementById('repliesList');
            const repliesCounter = document.getElementById('repliesCount');
            
            try {
                showRepliesStatus('ë‹µì¥ ì‚­ì œ ì¤‘...', 'info');
                
                // 1. í˜„ì¬ ëª¨ë“  í•™ìƒ ë‹µì¥ ì¡°íšŒ (ì•ˆì „í•˜ê²Œ)
                console.log('[SafeDelete] í•™ìƒ ë‹µì¥ ì¡°íšŒ ì‹œì‘...');
                const response = await smartFetch('tables/teacher_messages?limit=1000');
                const data = await response.json();
                
                if (!response.ok || !data.data) {
                    throw new Error(`ë‹µì¥ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
                }
                
                // 2. í•™ìƒì´ ë³´ë‚¸ ë©”ì‹œì§€ë§Œ í•„í„°ë§
                const studentReplies = data.data.filter(message => 
                    message.sender_type === 'student'
                );
                
                // 3. ë‹µì¥ê³¼ ì—°ê²°ëœ êµì‚¬ ë©”ì‹œì§€ ì°¾ê¸°
                const teacherMessageIds = new Set();
                studentReplies.forEach(reply => {
                    if (reply.reply_to) {
                        teacherMessageIds.add(reply.reply_to);
                    }
                });
                
                const teacherMessages = data.data.filter(message => 
                    message.sender_type === 'teacher' && teacherMessageIds.has(message.id)
                );
                
                console.log(`[SafeDelete] ì‚­ì œí•  ë‹µì¥ ìˆ˜: ${studentReplies.length}ê°œ`);
                console.log(`[SafeDelete] ì‚­ì œí•  êµì‚¬ ë©”ì‹œì§€ ìˆ˜: ${teacherMessages.length}ê°œ`);
                
                if (studentReplies.length === 0) {
                    showRepliesStatus('ì‚­ì œí•  ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                    return;
                }
                
                // 4. ë¨¼ì € í•™ìƒ ë‹µì¥ë“¤ì„ ì‚­ì œ
                let deletedReplies = 0;
                let deletedTeacherMessages = 0;
                let errorCount = 0;
                const totalItems = studentReplies.length + teacherMessages.length;
                
                for (const reply of studentReplies) {
                    try {
                        console.log(`[SafeDelete] ë‹µì¥ ì‚­ì œ ì‹œë„: ${reply.id} - "${reply.message}"`);
                        
                        // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                        showRepliesStatus(`ë‹µì¥ ì‚­ì œ ì¤‘... (${deletedReplies + 1}/${studentReplies.length})`, 'info');
                        
                        const deleteResponse = await smartFetch(`tables/teacher_messages/${reply.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (deleteResponse.ok) {
                            deletedReplies++;
                            console.log(`[SafeDelete] âœ… ë‹µì¥ ì‚­ì œ ì„±ê³µ: ${reply.id}`);
                        } else {
                            errorCount++;
                            const errorData = await deleteResponse.json().catch(() => ({}));
                            console.error(`[SafeDelete] âŒ ë‹µì¥ ì‚­ì œ ì‹¤íŒ¨: ${reply.id} (${deleteResponse.status})`, errorData);
                        }
                        
                    } catch (error) {
                        errorCount++;
                        console.error(`[SafeDelete] ë‹µì¥ ì‚­ì œ ì˜ˆì™¸: ${reply.id} - ${error.message}`, error);
                    }
                    
                    // ê° ì‚­ì œ ì‘ì—… ê°„ ì•½ê°„ì˜ ëŒ€ê¸° ì‹œê°„
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 5. ì´ì–´ì„œ êµì‚¬ ë©”ì‹œì§€ë“¤ì„ ì‚­ì œ
                for (const teacherMsg of teacherMessages) {
                    try {
                        console.log(`[SafeDelete] êµì‚¬ ë©”ì‹œì§€ ì‚­ì œ ì‹œë„: ${teacherMsg.id} - "${teacherMsg.message}"`);
                        
                        // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                        showRepliesStatus(`êµì‚¬ ë©”ì‹œì§€ ì‚­ì œ ì¤‘... (${deletedTeacherMessages + 1}/${teacherMessages.length})`, 'info');
                        
                        const deleteResponse = await smartFetch(`tables/teacher_messages/${teacherMsg.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (deleteResponse.ok) {
                            deletedTeacherMessages++;
                            console.log(`[SafeDelete] âœ… êµì‚¬ ë©”ì‹œì§€ ì‚­ì œ ì„±ê³µ: ${teacherMsg.id}`);
                        } else {
                            errorCount++;
                            const errorData = await deleteResponse.json().catch(() => ({}));
                            console.error(`[SafeDelete] âŒ êµì‚¬ ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨: ${teacherMsg.id} (${deleteResponse.status})`, errorData);
                        }
                        
                    } catch (error) {
                        errorCount++;
                        console.error(`[SafeDelete] êµì‚¬ ë©”ì‹œì§€ ì‚­ì œ ì˜ˆì™¸: ${teacherMsg.id} - ${error.message}`, error);
                    }
                    
                    // ê° ì‚­ì œ ì‘ì—… ê°„ ì•½ê°„ì˜ ëŒ€ê¸° ì‹œê°„
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 6. ê²°ê³¼ í‘œì‹œ
                const totalDeleted = deletedReplies + deletedTeacherMessages;
                if (totalDeleted > 0) {
                    showRepliesStatus(`âœ… ëŒ€í™” ì‚­ì œ ì™„ë£Œ: ë‹µì¥ ${deletedReplies}ê°œ, êµì‚¬ ë©”ì‹œì§€ ${deletedTeacherMessages}ê°œ ${errorCount > 0 ? `(ì‹¤íŒ¨ ${errorCount}ê°œ)` : ''}`, 'success');
                    
                    // 7. ë‹µì¥ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì•ˆì „í•˜ê²Œ)
                    await loadStudentReplies();
                    
                    console.log(`[SafeDelete] ëŒ€í™” ì¼ê´„ ì‚­ì œ ì™„ë£Œ: ë‹µì¥ ${deletedReplies}ê°œ, êµì‚¬ ë©”ì‹œì§€ ${deletedTeacherMessages}ê°œ, ì‹¤íŒ¨ ${errorCount}ê°œ`);
                } else {
                    throw new Error('ëª¨ë“  ëŒ€í™” ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('[SafeDelete] ëŒ€í™” ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨:', error);
                showRepliesStatus(`âŒ ëŒ€í™” ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                
                // ì˜¤ë¥˜ ì‹œì—ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadStudentReplies();
            }
        }
        
        // ë‹µì¥ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showRepliesStatus(message, type = 'info') {
            const statusElement = document.getElementById('repliesStatus');
            if (!statusElement) return;
            
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            
            statusElement.innerHTML = `<span class="${colors[type] || colors.info}">${message}</span>`;
            
            // 3ì´ˆ í›„ ìë™ ì‚¬ë¼ì§
            setTimeout(() => {
                if (statusElement) {
                    statusElement.innerHTML = '';
                }
            }, 3000);
        }

        // ========== ê°œë³„ ë©”ì‹œì§€ ë‹¨ê³„ì  ì„ íƒ í•¨ìˆ˜ë“¤ ==========
        
        // í•™ë…„ ì„ íƒ ì‹œ í•™ê¸‰ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateIndividualClassOptions() {
            console.log('[Messages] updateIndividualClassOptions í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const gradeSelect = document.getElementById('individualGradeSelect');
            const classSelect = document.getElementById('individualClassSelect');
            const studentSelect = document.getElementById('individualStudentSelect');
            const selectedInfo = document.getElementById('selectedStudentInfo');
            
            if (!gradeSelect || !classSelect || !studentSelect) {
                console.error('[Messages] í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            const selectedGrade = gradeSelect.value;
            console.log(`[Messages] ì„ íƒëœ í•™ë…„: "${selectedGrade}"`);
            
            // í•™ê¸‰ ì„ íƒ ì´ˆê¸°í™”
            classSelect.innerHTML = '<option value="">í•™ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            studentSelect.innerHTML = '<option value="">ë¨¼ì € í•™ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            studentSelect.disabled = true;
            if (selectedInfo) selectedInfo.classList.add('hidden');
            
            if (selectedGrade) {
                console.log('[Messages] ë©”ì‹œì§€ ëª¨ë“ˆ ìƒíƒœ ì²´í¬...');
                console.log('window.messagesModule exists:', !!window.messagesModule);
                console.log('window.messagesModule.currentStudents exists:', !!window.messagesModule?.currentStudents);
                console.log('currentStudents length:', window.messagesModule?.currentStudents?.length || 0);
                
                if (window.messagesModule && window.messagesModule.currentStudents) {
                    const allStudents = window.messagesModule.currentStudents;
                    console.log(`[Messages] ì „ì²´ í•™ìƒ ìˆ˜: ${allStudents.length}`);
                    
                    // ì²« ë²ˆì§¸ í•™ìƒ ë°ì´í„° êµ¬ì¡° í™•ì¸
                    if (allStudents.length > 0) {
                        console.log(`[Messages] ì²« ë²ˆì§¸ í•™ìƒ ë°ì´í„°:`, allStudents[0]);
                    }
                    
                    const gradeStudents = allStudents.filter(student => {
                        const studentGrade = student.grade || extractGradeFromClass(student.full_class || student.fullClass);
                        const match = studentGrade == selectedGrade;
                        if (match) {
                            console.log(`[Messages] ë§¤ì¹­ëœ í•™ìƒ:`, student);
                        }
                        return match;
                    });
                    
                    console.log(`[Messages] ${selectedGrade}í•™ë…„ í•™ìƒ ìˆ˜: ${gradeStudents.length}`);
                    
                    if (gradeStudents.length > 0) {
                        // í•™ê¸‰ ëª©ë¡ ì¶”ì¶œ
                        const classes = [...new Set(gradeStudents.map(student => {
                            const fullClass = student.full_class || student.fullClass || `${student.grade}-${student.classNum}`;
                            console.log(`[Messages] í•™ìƒ ${student.id}ì˜ í•™ê¸‰: ${fullClass}`);
                            return fullClass;
                        }))].filter(cls => cls && cls !== 'undefined-undefined').sort();
                        
                        console.log(`[Messages] ${selectedGrade}í•™ë…„ í•™ê¸‰ë“¤:`, classes);
                        
                        if (classes.length > 0) {
                            classes.forEach(cls => {
                                const option = document.createElement('option');
                                option.value = cls;
                                option.textContent = cls;
                                classSelect.appendChild(option);
                                console.log(`[Messages] ë“œë¡­ë‹¤ìš´ì— í•™ê¸‰ ì¶”ê°€: ${cls}`);
                            });
                            
                            classSelect.disabled = false;
                            console.log(`[Messages] í•™ê¸‰ ì„ íƒ í™œì„±í™”ë¨`);
                        } else {
                            console.warn(`[Messages] ${selectedGrade}í•™ë…„ì˜ í•™ê¸‰ì´ ì—†ìŒ`);
                            classSelect.innerHTML = '<option value="">í•´ë‹¹ í•™ë…„ì— í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                        }
                    } else {
                        console.warn(`[Messages] ${selectedGrade}í•™ë…„ í•™ìƒì´ ì—†ìŒ`);
                        classSelect.innerHTML = '<option value="">í•´ë‹¹ í•™ë…„ì— í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</option>';
                    }
                } else {
                    console.warn('[Messages] í•™ìƒ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                    console.log('- window.messagesModule:', window.messagesModule);
                    console.log('- currentStudents:', window.messagesModule?.currentStudents);
                    classSelect.innerHTML = '<option value="">í•™ìƒ ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘...</option>';
                }
            } else {
                classSelect.disabled = true;
                classSelect.innerHTML = '<option value="">ë¨¼ì € í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                console.log('[Messages] í•™ë…„ì´ ì„ íƒë˜ì§€ ì•ŠìŒ');
            }
        }
        
        // í•™ê¸‰ ì„ íƒ ì‹œ í•™ìƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateIndividualStudentOptions() {
            const gradeSelect = document.getElementById('individualGradeSelect');
            const classSelect = document.getElementById('individualClassSelect');
            const studentSelect = document.getElementById('individualStudentSelect');
            const selectedInfo = document.getElementById('selectedStudentInfo');
            
            const selectedGrade = gradeSelect.value;
            const selectedClass = classSelect.value;
            
            console.log(`[Messages] ì„ íƒëœ í•™ê¸‰: ${selectedClass}`);
            
            // í•™ìƒ ì„ íƒ ì´ˆê¸°í™”
            studentSelect.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
            selectedInfo.classList.add('hidden');
            
            if (selectedClass) {
                // ì„ íƒëœ í•™ê¸‰ì˜ í•™ìƒë“¤ ì°¾ê¸°
                if (window.messagesModule && window.messagesModule.currentStudents) {
                    const classStudents = window.messagesModule.currentStudents.filter(student => {
                        const fullClass = student.full_class || student.fullClass || `${student.grade}-${student.classNum}`;
                        return fullClass === selectedClass;
                    });
                    
                    console.log(`[Messages] ${selectedClass} í•™ê¸‰ í•™ìƒ ìˆ˜: ${classStudents.length}`);
                    
                    // í•™ìƒë“¤ì„ ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
                    classStudents.sort((a, b) => a.name.localeCompare(b.name));
                    
                    classStudents.forEach(student => {
                        const studentId = student.student_id || student.studentId || student.id;
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.setAttribute('data-name', student.name);
                        option.setAttribute('data-class', selectedClass);
                        option.textContent = `${student.name} (${studentId})`;
                        studentSelect.appendChild(option);
                    });
                    
                    studentSelect.disabled = false;
                    
                    // í•™ìƒ ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
                    studentSelect.onchange = function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption && selectedOption.value) {
                            const studentName = selectedOption.getAttribute('data-name');
                            const studentClass = selectedOption.getAttribute('data-class');
                            
                            document.getElementById('selectedStudentName').textContent = studentName;
                            document.getElementById('selectedStudentClass').textContent = `(${studentClass})`;
                            selectedInfo.classList.remove('hidden');
                            
                            console.log(`[Messages] í•™ìƒ ì„ íƒë¨: ${studentName} (${selectedOption.value})`);
                        } else {
                            selectedInfo.classList.add('hidden');
                        }
                    };
                } else {
                    console.warn('[Messages] í•™ìƒ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                    studentSelect.innerHTML = '<option value="">í•™ìƒ ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘...</option>';
                }
            } else {
                studentSelect.disabled = true;
                studentSelect.innerHTML = '<option value="">ë¨¼ì € í•™ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            }
        }
        
        // í•™ê¸‰ëª…ì—ì„œ í•™ë…„ ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜
        function extractGradeFromClass(fullClass) {
            if (!fullClass) return null;
            const match = fullClass.match(/^(\d+)-/);
            return match ? match[1] : null;
        }

        // ========== ê¸°ë³¸ ê¸°ëŠ¥ ==========
        function updateTime() {
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleString('ko-KR');
            }
        }
        
        function teacherLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ëª¨ë“  ê´€ë¦¬ì ê´€ë ¨ ì„¸ì…˜ ë°ì´í„° ì •ë¦¬
                sessionStorage.removeItem('teacherLoggedIn');
                sessionStorage.removeItem('adminLoginTime');
                
                log('ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'success');
                window.location.href = 'index.html';
            }
        }
        
        function checkTeacherAuth() {
            const isLoggedIn = sessionStorage.getItem('teacherLoggedIn');
            if (!isLoggedIn) {
                showAdminPasswordDialog();
            }
        }

        function showAdminPasswordDialog() {
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
            const dialogHTML = `
                <div id="adminPasswordDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
                        <div class="text-center mb-6">
                            <i class="fas fa-shield-alt text-4xl text-blue-500 mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ì¸ì¦</h2>
                            <p class="text-gray-600">ê´€ë¦¬ì í˜ì´ì§€ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="adminPasswordInput" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                   onkeypress="if(event.key==='Enter') verifyAdminPassword()">
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="verifyAdminPassword()" 
                                    class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors font-medium">
                                <i class="fas fa-key mr-2"></i>í™•ì¸
                            </button>
                            <button onclick="cancelAdminAuth()" 
                                    class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition-colors font-medium">
                                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                            </button>
                        </div>
                        
                        <div id="passwordError" class="mt-4 text-red-600 text-sm text-center hidden">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            
            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const input = document.getElementById('adminPasswordInput');
                if (input) input.focus();
            }, 100);
        }

        function verifyAdminPassword() {
            const input = document.getElementById('adminPasswordInput');
            const errorDiv = document.getElementById('passwordError');
            const password = input.value.trim();
            
            // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (ì—¬ëŸ¬ ê°œì˜ ë¹„ë°€ë²ˆí˜¸ í—ˆìš©)
            const validPasswords = [
                'admin2024',
                'teacher123', 
                'kimbap2024',
                'ì°½ê±´ìƒ˜',
                'manager'
            ];
            
            if (validPasswords.includes(password)) {
                // ì¸ì¦ ì„±ê³µ
                sessionStorage.setItem('teacherLoggedIn', 'true');
                sessionStorage.setItem('adminLoginTime', new Date().toISOString());
                
                // ë‹¤ì´ì–¼ë¡œê·¸ ì œê±°
                const dialog = document.getElementById('adminPasswordDialog');
                if (dialog) {
                    dialog.remove();
                }
                
                // ì„±ê³µ ë©”ì‹œì§€
                log('ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ', 'success');
                
                // í˜ì´ì§€ ì´ˆê¸°í™” ê³„ì† ì§„í–‰
                initializeAdminPage();
                
            } else {
                // ì¸ì¦ ì‹¤íŒ¨
                errorDiv.classList.remove('hidden');
                input.value = '';
                input.focus();
                
                // 3ì´ˆ í›„ ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¹€
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
            }
        }

        function cancelAdminAuth() {
            const dialog = document.getElementById('adminPasswordDialog');
            if (dialog) {
                dialog.remove();
            }
            
            // ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
            window.location.href = 'index.html';
        }

        function initializeAdminPage() {
            console.log('ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // Supabase ì´ˆê¸°í™”
            setTimeout(() => {
                if (typeof initSupabaseClient === 'function') {
                    const initialized = initSupabaseClient();
                    if (initialized) {
                        log('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ', 'success');
                    } else {
                        log('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
                    }
                } else if (typeof initSupabase === 'function') {
                    const initialized = initSupabase();
                    if (initialized) {
                        log('Supabase ì´ˆê¸°í™” ì„±ê³µ', 'success');
                    } else {
                        log('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
                    }
                } else {
                    log('Supabase ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                }
                
                // ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬
                checkSystemStatus();
            }, 500);
            
            // ì‹œê°„ ì—…ë°ì´íŠ¸
            updateTime();
            setInterval(updateTime, 1000);
        }

        // ========== ì´ˆê¸°í™” ==========
        document.addEventListener('DOMContentLoaded', function() {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ê¶Œí•œ ì²´í¬ (ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ì´ˆê¸°í™”)
            const isLoggedIn = sessionStorage.getItem('teacherLoggedIn');
            if (isLoggedIn) {
                initializeAdminPage();
            } else {
                checkTeacherAuth();
            }
        });
        


        // ========== ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬ ==========
        window.addEventListener('error', function(e) {
            log(`ì „ì—­ ì—ëŸ¬: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            log(`Promise ì—ëŸ¬: ${e.reason}`, 'error');
        });

        // í…Œì´ë¸” ê´€ë¦¬ í•¨ìˆ˜ë“¤ ì„¤ì •
        function setupTableManagementFunctions() {
            // í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ - í•™ìŠµì•ˆë‚´ìš© ê°„ì†Œí™”
            window.TableSchemaUpdate = async function(tableName, fields) {
                try {
                    console.log(`[Admin] í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸: ${tableName}`);
                    
                    // í•™ìŠµì•ˆë‚´ í…Œì´ë¸”ì´ë©´ RESTful APIë¡œ í…ŒìŠ¤íŠ¸
                    if (tableName === 'learning_guides') {
                        const testResponse = await fetch(`tables/${tableName}?limit=1`);
                        if (testResponse.ok) {
                            console.log(`[Admin] í…Œì´ë¸” ${tableName} ì ‘ê·¼ ê°€ëŠ¥ - ìŠ¤í‚¤ë§ˆ OK`);
                            return true;
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.error(`[Admin] í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜ (${tableName}):`, error);
                    return false;
                }
            };
            
            // í…Œì´ë¸” ë°ì´í„° ì¶”ê°€ í•¨ìˆ˜
            window.TableDataAdd = async function(tableName, rows) {
                try {
                    console.log(`[Admin] í…Œì´ë¸” ë°ì´í„° ì¶”ê°€: ${tableName}, ${rows.length}ê°œ í–‰`);
                    
                    const promises = rows.map(row => 
                        fetch(`tables/${tableName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(row)
                        })
                    );
                    
                    await Promise.all(promises);
                    console.log(`[Admin] í…Œì´ë¸” ë°ì´í„° ì¶”ê°€ ì™„ë£Œ: ${tableName}`);
                    
                    return true;
                } catch (error) {
                    console.error(`[Admin] í…Œì´ë¸” ë°ì´í„° ì¶”ê°€ ì˜¤ë¥˜ (${tableName}):`, error);
                    throw error;
                }
            };
            
            console.log('[Admin] í…Œì´ë¸” ê´€ë¦¬ í•¨ìˆ˜ë“¤ ì„¤ì • ì™„ë£Œ');
        }
    </script>

    <!-- Supabase ì´ˆê¸°í™” -->
    <script>
        console.log('[Admin] Supabase ì´ˆê¸°í™” ì‹œì‘');
        
        let globalSupabaseClient = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Admin] DOM ë¡œë“œ ì™„ë£Œ, Supabase ì´ˆê¸°í™” ì‹œì‘');
            
            function initializeSupabaseForAdmin() {
                if (typeof window.supabase !== 'undefined' && typeof SUPABASE_URL !== 'undefined') {
                    try {
                        globalSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('[Admin] Supabase ì´ˆê¸°í™” ì„±ê³µ');
                        
                        // ê´€ë¦¬ì ëª¨ë“ˆì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ ì´ë²¤íŠ¸ ë°œì†¡
                        window.dispatchEvent(new CustomEvent('adminSupabaseReady', { 
                            detail: { client: globalSupabaseClient } 
                        }));
                        
                        // í…Œì´ë¸” ê´€ë¦¬ í•¨ìˆ˜ë“¤ ì •ì˜ (ì•ˆì „í•˜ê²Œ)
                        if (typeof setupTableManagementFunctions === 'function') {
                            setupTableManagementFunctions();
                        } else {
                            console.warn('[Admin] setupTableManagementFunctions í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        }
                        
                        // ì•ˆì „í•œ ì¼ê´„ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€)
                        const safeDeleteBtn = document.getElementById('safeDeleteAllBtn');
                        if (safeDeleteBtn) {
                            safeDeleteBtn.addEventListener('click', function(event) {
                                console.log('[SafeDelete] ì•ˆì „í•œ ë²„íŠ¼ í´ë¦­ ê°ì§€');
                                safeDeleteAllReplies(event);
                            }, true); // capture ëª¨ë“œë¡œ ì´ë²¤íŠ¸ ìš°ì„  ì²˜ë¦¬
                        }
                        
                        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ì€ ì´ˆê¸°í™” ì™„ë£Œ í›„ ë³„ë„ë¡œ ì‹¤í–‰
                        console.log('[Admin] Supabase ì´ˆê¸°í™”ë§Œ ì™„ë£Œ, ì „ì—­ í•¨ìˆ˜ëŠ” ë³„ë„ë¡œ ë“±ë¡ ì˜ˆì •');
                        
                        // í…Œì´ë¸” ê´€ë¦¬ í•¨ìˆ˜ë“¤ì€ ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì •ë¨ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
                        console.log('[Admin] í…Œì´ë¸” ê´€ë¦¬ í•¨ìˆ˜ëŠ” ì´ë¯¸ ì„¤ì •ë˜ì—ˆìŒ');
                        
                        // ì‹œìŠ¤í…œ ìƒíƒœ ì¦‰ì‹œ ì²´í¬
                        console.log('[Admin] ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ì‹¤í–‰');
                        checkSystemStatus();
                        
                        return true;
                    } catch (error) {
                        console.error('[Admin] Supabase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                        return false;
                    }
                } else {
                    console.log('[Admin] Supabase ë˜ëŠ” ì„¤ì • ì•„ì§ ì¤€ë¹„ ì•ˆë¨');
                    return false;
                }
            }
            
            // ì¦‰ì‹œ ì´ˆê¸°í™” ì‹œë„
            if (!initializeSupabaseForAdmin()) {
                // 1ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„
                setTimeout(() => {
                    if (!initializeSupabaseForAdmin()) {
                        console.warn('[Admin] Supabase ì´ˆê¸°í™” 2ë²ˆ ì‹¤íŒ¨ - ë¡œì»¬ ëª¨ë“œë¡œ ì§„í–‰');
                    }
                }, 1000);
            }
        });
    </script>
    
    <script src="static/supabase-config.js"></script>
    <script src="static/supabase-api.js"></script>
    
    <!-- ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (ëª¨ë“  í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ í›„) -->
    <script>
        // ë‹¨ê³„ë³„ ë‚´ìš© ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function openStageContentManager() {
            console.log('[Admin] ë‹¨ê³„ë³„ ë‚´ìš© ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™');
            window.location.href = 'admin-stage-content.html';
        }

        // ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í›„ ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.addEventListener('load', function() {
            console.log('[Admin] ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ - ì „ì—­ í•¨ìˆ˜ ë“±ë¡ ì‹œì‘');
            
            // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (ì•ˆì „í•˜ê²Œ)
            if (typeof loadMessagesModule === 'function') window.loadMessagesModule = loadMessagesModule;
            if (typeof loadLuckyDrawModule === 'function') window.loadLuckyDrawModule = loadLuckyDrawModule;
            if (typeof loadStudentsModule === 'function') window.loadStudentsModule = loadStudentsModule;  
            if (typeof loadPointsModule === 'function') window.loadPointsModule = loadPointsModule;
            // ğŸ”§ ì—­í• ë°°ì • í•¨ìˆ˜ ê°•ì œ ë“±ë¡ (ëª¨ë‹¬ ì°¨ë‹¨)
            window.loadRolesModuleWrapper = loadRolesModuleWrapper;
            console.log('âœ… [FIXED] loadRolesModuleWrapper ê°•ì œ ë“±ë¡ë¨ - ëª¨ë‹¬ ì°¨ë‹¨ë¨');
            if (typeof loadStagesModule === 'function') window.loadStagesModule = loadStagesModule;
            if (typeof loadGuidesModule === 'function') window.loadGuidesModule = loadGuidesModule;
            if (typeof loadSpinnerModule === 'function') window.loadSpinnerModule = loadSpinnerModule;
            if (typeof checkSystemStatus === 'function') window.checkSystemStatus = checkSystemStatus;
            if (typeof openStageContentManager === 'function') window.openStageContentManager = openStageContentManager;
            
            console.log('[Admin] ì „ì—­ í•¨ìˆ˜ ë“±ë¡ ì™„ë£Œ');
            
            // ğŸ”§ ì¶”ê°€ ë³´ì•ˆ: DOM ì¡°ì‘ìœ¼ë¡œ ê°•ì œ í•¨ìˆ˜ ì¬ë“±ë¡
            setTimeout(() => {
                window.loadRolesModuleWrapper = loadRolesModuleWrapper;
                console.log('ğŸ”’ [SECURITY] loadRolesModuleWrapper ë³´ì•ˆ ì¬ë“±ë¡ ì™„ë£Œ');
            }, 500);
            
            // ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬
            if (typeof checkSystemStatus === 'function') {
                checkSystemStatus();
            }
        });
    </script>
    
    <!-- ê´€ë¦¬ì ëª¨ë“ˆë“¤ -->
    <script src="static/api-wrapper.js"></script>
    <script src="static/admin-students.js"></script>
    <!-- <script src="static/admin-roles.js"></script> êµ¬ë¬¸ ì˜¤ë¥˜ë¡œ ì„ì‹œ ë¹„í™œì„±í™” -->
    <script src="static/admin-stage-config.js"></script>
    <script src="static/admin-guides.js"></script>
    <!-- <script src="test-admin-button.js"></script> -->

</body>
</html>