<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 페이지 - 역할 확인</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 커스텀 CSS Grid 시스템 */
        .main-container {
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            padding: 1rem 3rem;
            box-sizing: border-box;
        }
        
        .header-area {
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            color: white;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 36vh 36vh;
            gap: 0.8rem;
            height: 100%;
            max-height: calc(100vh - 140px);
            margin-bottom: 1rem;
        }
        
        .grid-item {
            border-radius: 1rem;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            min-height: 0; /* flex 아이템이 축소될 수 있도록 */
            max-height: 36vh; /* 그리드 행 높이와 일치 */
        }
        
        /* 실제 카드 스타일 */
        .student-info, .daily-points, 
        .daily-tasks, .notice-board, .teacher-message {
            background-color: white;
        }
        
        /* === 개선된 플립 카드 디자인 === */
        /* 플립 카드 컨테이너 - 선생님쪽지함과 완전 동일한 크기 */
        .flip-card {
            width: 100%;
            height: 100%;
            max-height: 100%;
            margin: 0;
            padding: 0;
            perspective: 1000px;
            cursor: pointer;
            box-sizing: border-box;
        }
        
        /* 카드 내부 컨테이너 (3D 변환용) */
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            max-height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            box-sizing: border-box;
        }
        
        /* 플립 상태 */
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        /* 카드 앞면과 뒷면의 공통 스타일 */
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 카드 앞면 */
        .card-front {
            background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
            color: white;
            justify-content: center;
            align-items: center;
        }
        
        /* 카드 뒷면 */
        .card-back {
            background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
            color: white;
            transform: rotateY(180deg);
            padding: 1rem;
            position: relative;
        }

        /* 뒷면 컨텐츠 영역 - 전체 사용 */
        .card-back-content {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.8rem;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 활동 안내 텍스트 */
        #detailMissions {
            color: #fef08a;
            font-size: 1.25rem;
            line-height: 1.8;
            font-weight: 600;
            white-space: pre-wrap;
            text-align: center;
            width: 100%;
        }
        
        /* 호버 효과 */
        .flip-card:hover .flip-card-inner {
            transform: scale(1.05);
        }
        
        .flip-card.flipped:hover .flip-card-inner {
            transform: rotateY(180deg) scale(1.05);
        }
        
        /* === 메시지 플립 카드 스타일 === */
        .message-flip-card {
            width: 100%;
            height: calc(100% - 3rem);
            position: relative;
            perspective: 1000px;
        }
        
        .message-flip-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .message-flip-card.flipped .message-flip-inner {
            transform: rotateY(180deg);
        }
        
        .message-card-front, .message-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .message-card-front {
            background: white;
        }
        
        .message-card-back {
            background: linear-gradient(135deg, #f8a5a5 0%, #f8a5a5 100%);
            transform: rotateY(180deg);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* 메시지 카드 버튼 강조 스타일 */
        .message-card-back button {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }
        
        .message-card-back button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 학습안내 플립카드 스타일 */
        .learning-guide-flip-card {
            cursor: pointer;
            perspective: 1000px;
            transition: transform 0.3s ease;
        }
        
        .learning-guide-flip-card:hover {
            transform: scale(1.02);
        }
        
        .learning-guide-flip-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        
        .learning-guide-flip-card.flipped .learning-guide-flip-inner {
            transform: rotateY(180deg);
        }
        
        .learning-guide-front, .learning-guide-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .learning-guide-front {
            background: linear-gradient(145deg, #ffffff 0%, #f8faff 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .learning-guide-back {
            background: linear-gradient(135deg, #7c8fe8 0%, #8b7ab8 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transform: rotateY(180deg);
        }
        
        /* 링크 스타일 */
        .guide-link {
            color: #c7d2fe;
            text-decoration: underline;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .guide-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fbbf24;
            text-decoration: none;
        }
        
        /* 학습안내 내용 스타일 */
        .learning-guide-content {
            line-height: 1.6;
            text-align: left;
        }
        
        .learning-guide-content p {
            margin-bottom: 0.75rem;
        }
        
        .learning-guide-content p:last-child {
            margin-bottom: 0;
        }
        
        /* === 오늘의할일 플립카드 스타일 === */
        .daily-tasks-flip-card {
            width: 100%;
            height: 100%;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
        }
        
        .daily-tasks-flip-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        
        .daily-tasks-flip-card.flipped .daily-tasks-flip-inner {
            transform: rotateY(180deg);
        }
        
        .daily-tasks-front, .daily-tasks-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 1rem;
            overflow: hidden;
        }
        
        .daily-tasks-front {
            background: linear-gradient(145deg, #ffffff 0%, #f8faff 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .daily-tasks-back {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transform: rotateY(180deg);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        
        /* 플립 힌트 애니메이션 */
        .daily-tasks-flip-card:hover .daily-tasks-front {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .daily-tasks-flip-card.flipped:hover .daily-tasks-back {
            transform: rotateY(180deg) scale(1.02);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        /* 공지사항, 선생님말씀 텍스트 크기 조정 */
        .notice-text {
            font-size: 0.9em !important;
            line-height: 1.4 !important;
            text-align: justify !important;
            text-justify: inter-word !important;
        }
        
        /* 전체적인 시각 개선 */
        .grid-item {
            background: linear-gradient(145deg, #ffffff 0%, #f8faff 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        /* 역할 배정 섹션 배경 설정 - 선생님쪽지함과 동일한 크기 */
        .grid-item.role-assignment {
            background: linear-gradient(145deg, #ffffff 0%, #f8faff 100%);
            padding: 0.8rem; /* 다른 카드와 완전 동일한 패딩 */
            box-sizing: border-box;
        }
        
        .grid-item h3 {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* border-3 클래스 추가 */
        .border-3 {
            border-width: 3px;
        }
        
        /* 쪽지함 메시지 리스트 스타일 */
        .message-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.25rem;
            height: 100%;
            overflow-y: auto;
        }
        
        .message-list-item {
            background: white;
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .message-list-item:hover {
            background: #f9fafb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .message-list-item.first-item {
            border-left: 3px solid #ef4444;
        }
        
        .message-item-content {
            flex: 1;
            min-width: 0;
            padding: 0 0.25rem;
        }
        
        .message-text {
            font-size: 0.85rem;
            line-height: 1.3;
            color: #374151;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }
        
        .message-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: #6b7280;
        }
        
        .message-date {
            white-space: nowrap;
        }
        
        .new-badge {
            background: #ef4444;
            color: white;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            font-size: 0.6rem;
            font-weight: bold;
        }
        
        .reply-indicator {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .reply-prefix {
            font-weight: 500;
            color: #9ca3af;
        }

        
        /* 공지사항 카드 스타일 - 선생님말씀과 비슷한 톤 */
        .notice-card {
            background: linear-gradient(135deg, #faf8fc 0%, #f3e5f5 100%);
            border-radius: 0.5rem;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #ba68c8;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .notice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .notice-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #000000;
            margin-bottom: 0.3rem;
        }
        
        .notice-content {
            font-size: 0.8rem;
            color: #000000;
            line-height: 1.6;
        }
        
        .notice-date {
            font-size: 0.6rem;
            color: #666666;
            margin-top: 0.4rem;
            text-align: right;
        }
        
        /* 이미지 역할 - 배치 개선 */
        #imageRoleDisplay {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            gap: 0;
            position: relative; /* 제목 위치 조정을 위한 relative */
        }
        
        #roleImage {
            max-height: 75px !important; /* 이미지 크기 50% 축소 (150px → 75px) */
            max-width: 85%;
            width: auto;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #imageRoleName {
            font-size: 1.25rem; /* 폰트 크기 50% 축소 (1.75rem → 1.25rem) */
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 4px rgba(0,0,0,0.4);
            margin: 0;
            padding: 0;
            text-align: center;
            position: absolute;
            bottom: 0.5rem; /* 배색카드 끝에서 0.5rem 위로 조정 */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
        }
        
        /* 반응형 */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(6, minmax(300px, auto));
                gap: 1.5rem;
            }
            .grid-item {
                padding: 2rem;
            }
            .main-container {
                padding: 1rem;
                gap: 1rem;
            }
            .header-area {
                height: 100px;
                padding: 0 2rem;
            }
        }
        
        /* 13인치 크롬북 특별 최적화 (1366x768) */
        @media (max-width: 1366px) and (max-height: 768px) {
            #roleImage {
                max-height: 60px !important; /* 13인치에서 이미지 크기 50% 축소 (120px → 60px) */
                max-width: 80%;
            }
            
            #imageRoleName {
                font-size: 1.0rem; /* 폰트 크기 50% 축소 (1.5rem → 1.0rem) */
                bottom: 0.25rem; /* 13인치에서 0.25rem로 조정 */
            }
            
            /* role-assignment 특별 min-height 제거 - 모든 카드 동일한 크기 */
            
            #imageRoleDisplay {
                padding: 0; /* 13인치에서도 여백 제거 */
                gap: 0; /* gap도 제거 */
            }
        }
        
        /* 더 작은 화면 (11인치 이하) */
        @media (max-width: 1200px) and (max-height: 700px) {
            #roleImage {
                max-height: 55px !important; /* 작은 화면에서 이미지 크기 50% 축소 (110px → 55px) */
                max-width: 75%;
            }
            
            #imageRoleName {
                font-size: 0.95rem; /* 폰트 크기 50% 축소 (1.25rem → 0.95rem) */
                bottom: 0.3rem; /* 작은 화면에서 0.3rem로 조정 */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 m-0 p-0">
    
    <!-- 로그인 섹션 -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="mb-4">
                    <i class="fas fa-sushi text-4xl text-purple-500 mb-2"></i>
                    <h1 class="text-2xl font-bold text-gray-800">창건샘의 김밥교실</h1>
                </div>
                <i class="fas fa-sign-in-alt text-3xl text-purple-500 mb-3"></i>
                <h2 class="text-xl font-bold text-gray-800">간편 로그인</h2>
                <p class="text-gray-600 mt-2">학번과 이름을 입력하세요</p>
            </div>

            <form onsubmit="studentLogin(event)">
                <!-- 에러 메시지 영역 -->
                <div id="loginErrorMessage" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                        <span id="loginErrorText" class="text-red-700 text-sm"></span>
                    </div>
                </div>
                
                <!-- 성공 메시지 영역 -->
                <div id="loginSuccessMessage" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-green-700 text-sm">로그인 성공! 잠시만 기다려주세요...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card mr-1 text-purple-500"></i>학번
                    </label>
                    <input type="text" id="loginStudentId" 
                           placeholder="예: 4103" 
                           pattern="[0-9]{4}"
                           maxlength="4"
                           required
                           autocomplete="off"
                           class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg transition-colors">
                    <p class="text-xs text-gray-500 mt-1">4자리 숫자 (학년/반/번호)</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1 text-purple-500"></i>이름
                    </label>
                    <input type="text" id="loginStudentName" 
                           placeholder="예: 홍길동" 
                           required
                           autocomplete="off"
                           class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg transition-colors">
                </div>

                <button type="submit" id="loginButton"
                        class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold py-3 rounded-lg hover:opacity-90 transition transform hover:scale-105 disabled:opacity-50 disabled:transform-none disabled:cursor-not-allowed">
                    <span id="loginButtonText">
                        <i class="fas fa-arrow-right mr-2"></i>로그인
                    </span>
                    <span id="loginLoadingText" class="hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>로그인 중...
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- 메인 레이아웃 (로그인 후) -->
    <div id="roleSection" class="main-container hidden">
        
        <!-- 헤더 영역 -->
        <div class="header-area">
            <div class="flex items-center space-x-3">
                <i class="fas fa-sushi text-2xl"></i>
                <h1 class="font-bold" style="font-size: 3rem;">참치김밥</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">

                    <p class="font-bold" style="font-size: 2rem;">
                        <span id="displayStudentId" class="text-yellow-300"></span> 
                        <span id="displayStudentName" class="ml-2"></span>
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <a href="index.html" class="text-white hover:text-yellow-300 transition">
                        <i class="fas fa-home text-xl"></i>
                    </a>
                    <button onclick="logout()" class="text-white hover:text-yellow-300 transition">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 6영역 그리드 -->
        <div class="content-grid">
            
            <!-- 1. 학생정보 (좌상) -->
            <div class="grid-item student-info">
                <h3 class="font-bold mb-2 text-center" style="font-size: 1.4rem;">👤 학생 정보</h3>
                <div class="text-center flex-1 flex flex-col justify-center">
                    <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user text-purple-600 text-2xl"></i>
                    </div>
                    <p class="text-gray-500 mb-1" style="font-size: 0.8rem;">현재 로그인</p>
                    <p class="font-bold text-gray-800 leading-tight" style="font-size: 1rem;">
                        <span id="displayStudentId2" class="text-purple-600"></span> 
                        <span id="displayStudentName2" class="ml-2"></span>
                    </p>
                </div>
            </div>

            <!-- 2. 오늘의 포인트 (중상) -->
            <div id="pointDisplaySection" class="grid-item daily-points">
                <h3 class="font-bold mb-2 text-center" style="font-size: 1.4rem;">🪙 오늘의 포인트</h3>
                <p class="text-gray-500 mb-1 text-center" id="todayDate" style="font-size: 0.7rem;"></p>
                <div class="text-center flex-1 flex flex-col justify-center">
                    <div class="flex items-center justify-center mb-4">
                        <i class="fas fa-coins text-yellow-500 text-3xl mr-3"></i>
                        <div class="font-bold text-yellow-600" id="totalPoints" style="font-size: 1.5rem;">0</div>
                    </div>
                    <div class="text-gray-500 mb-1" style="font-size: 0.7rem;">현재 포인트</div>
                    <div class="bg-gray-200 rounded-full h-4 mb-2 mt-1">
                        <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 h-4 rounded-full transition-all duration-500 flex items-center justify-end pr-2" 
                             id="progressBar" style="width: 0%">
                            <i class="fas fa-star text-white text-xs opacity-90"></i>
                        </div>
                    </div>
                    <div class="text-gray-600 text-center font-bold" id="progressText" style="font-size: 0.9rem;">0 / 10 포인트</div>
                </div>
            </div>

            <!-- 3. 오늘의 할일 → 오늘의 뽑기 (플립 카드) -->
            <div class="grid-item daily-tasks">
                <!-- 플립 카드 컨테이너 -->
                <div class="daily-tasks-flip-card" id="dailyTasksFlipCard" onclick="console.log('🚨 CLICK EVENT 확인!'); toggleDailyTasksCard()">
                    <div class="daily-tasks-flip-inner">
                        
                        <!-- 앞면: 오늘의 할일 -->
                        <div class="daily-tasks-front">
                            <div id="taskSection" class="flex flex-col h-full">
                                <h3 class="font-bold mb-1 text-center" style="font-size: 1.4rem;">📋 오늘의 할일</h3>
                                
                                <div class="space-y-1 flex-1 flex flex-col justify-center">
                                    <!-- Stage 1 -->
                                    <div class="border border-blue-200 rounded-md p-1 bg-white shadow-sm hover:shadow-md transition-shadow" id="stage1Card">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-1">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-100" id="stage1Icon">
                                                    <span style="font-size: 1.2rem;">🍙</span>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-gray-800" style="font-size: 0.6rem;">1단계: 김밥말기</h4>
                                                    <p class="text-gray-600" style="font-size: 0.5rem;">김밥을 말아보세요 (+1포인트)</p>
                                                </div>
                                            </div>
                                            <button onclick="completeStage(1); event.stopPropagation();" id="stage1Btn" class="px-2 py-1 rounded text-xs font-medium transition-colors" style="min-width: 3rem;">시작</button>
                                        </div>
                                    </div>

                                    <!-- Stage 2 -->
                                    <div class="border border-blue-200 rounded-md p-1 bg-white shadow-sm hover:shadow-md transition-shadow" id="stage2Card">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-1">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center bg-green-100" id="stage2Icon">
                                                    <span style="font-size: 1.2rem;">✨</span>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-gray-800" style="font-size: 0.6rem;">2단계: 김밥썰기</h4>
                                                    <p class="text-gray-600" style="font-size: 0.5rem;">김밥을 예쁘게 썰어보세요 (+1포인트)</p>
                                                </div>
                                            </div>
                                            <button onclick="completeStage(2); event.stopPropagation();" id="stage2Btn" class="px-2 py-1 rounded text-xs font-medium transition-colors" style="min-width: 3rem;">잠금</button>
                                        </div>
                                    </div>

                                    <!-- Stage 3 -->
                                    <div class="border border-blue-200 rounded-md p-1 bg-white shadow-sm hover:shadow-md transition-shadow" id="stage3Card">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-1">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center bg-purple-100" id="stage3Icon">
                                                    <span style="font-size: 1.2rem;">➕</span>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-gray-800" style="font-size: 0.6rem;">3단계: 김밥추가</h4>
                                                    <p class="text-gray-600" style="font-size: 0.5rem;">더 많은 김밥을 만들어보세요 (+1포인트)</p>
                                                </div>
                                            </div>
                                            <button onclick="completeStage(3); event.stopPropagation();" id="stage3Btn" class="px-2 py-1 rounded text-xs font-medium transition-colors" style="min-width: 3rem;">잠금</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 플립 힌트 (2단계 완료시에만 표시) -->
                                <div id="flipHint" class="hidden text-center mt-2">
                                    <p class="text-xs text-purple-600 animate-pulse">
                                        🎁 클릭하여 오늘의 뽑기 하기!
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 뒷면: 오늘의 뽑기 -->
                        <div class="daily-tasks-back">
                            <div class="flex flex-col h-full justify-center items-center text-center p-4">
                                <div id="luckyDrawContent">
                                    <!-- 뽑기 사용 가능 상태 -->
                                    <div id="luckyDrawAvailable" class="hidden">
                                        <h3 class="text-2xl font-bold text-white mb-4">🎁 오늘의 뽑기</h3>
                                        <div class="mb-6">
                                            <div class="text-6xl mb-4">🎰</div>
                                            <p class="text-white text-lg mb-2">2단계를 완료했습니다!</p>
                                            <p class="text-purple-200 text-sm mb-4">특별한 선물을 받아보세요</p>
                                        </div>
                                        <button onclick="performLuckyDraw(); event.stopPropagation();" 
                                                class="bg-white bg-opacity-20 backdrop-blur text-white py-3 px-6 rounded-lg hover:bg-opacity-30 transition text-lg font-bold border-2 border-white border-opacity-40 shadow-lg">
                                            🎲 뽑기 하기!
                                        </button>
                                    </div>
                                    
                                    <!-- 조건 미충족 상태 -->
                                    <div id="luckyDrawUnavailable">
                                        <h3 class="text-xl font-bold text-white mb-4">🔒 오늘의 뽑기</h3>
                                        <div class="mb-6">
                                            <div class="text-4xl mb-4 opacity-50">🎰</div>
                                            <p class="text-white text-base mb-2">2단계를 먼저 완료해주세요!</p>
                                            <p class="text-purple-200 text-sm">완료 후 특별한 선물을 받을 수 있어요</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 이미 뽑기 완료 상태 -->
                                    <div id="luckyDrawCompleted" class="hidden">
                                        <h3 class="text-xl font-bold text-white mb-4">✅ 뽑기 완료</h3>
                                        <div class="mb-6">
                                            <div class="text-4xl mb-4">🎁</div>
                                            <p class="text-white text-base mb-2">오늘 이미 뽑기를 했습니다</p>
                                            <p class="text-purple-200 text-sm">내일 다시 도전해보세요!</p>
                                        </div>
                                        <div id="todayDrawResult" class="bg-white bg-opacity-20 rounded-lg p-3 mt-4">
                                            <p class="text-white font-bold">오늘의 결과:</p>
                                            <p class="text-yellow-200 text-lg" id="todayDrawMessage">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- 4. 역할배정 -->
            <div class="grid-item role-assignment">
                <h3 class="font-bold mb-2 text-center" style="font-size: 1.4rem;">🎭 역할 배정</h3>
                
                <!-- No Role Message -->
                <div id="noRoleMessage" class="hidden text-center flex-1 flex flex-col justify-center">
                    <i class="fas fa-hourglass-half text-3xl text-yellow-500 mb-3"></i>
                    <p class="text-gray-600 mb-2 font-semibold" style="font-size: 1rem;">선생님이 역할을 배정할 때만<br>표시됩니다</p>
                    <button onclick="checkRoleAgain()" class="bg-yellow-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-yellow-600 transition-colors" style="font-size: 0.8rem;">
                        <i class="fas fa-sync-alt mr-2 text-sm"></i>다시 확인
                    </button>
                </div>

                <!-- Role Display -->
                <div id="roleDisplay" class="hidden flex-1 flex flex-col min-h-0">
                    <div id="roleCard" class="flex-1 flex flex-col h-full max-h-full">
                        <!-- 개선된 플립 카드 구조 (3D 효과) -->
                        <div class="flip-card" id="flipCard" onclick="flipCard()">
                            <div class="flip-card-inner">
                                <!-- 카드 앞면 - 완전 새로운 구조 -->
                                <div class="card-face card-front">
                                    <!-- 단일 역할 표시 영역 -->
                                    <div id="roleContent" class="h-full flex flex-col justify-center items-center text-center">
                                        <!-- 역할 제목 (항상 표시) -->
                                        <h1 id="mainRoleTitle" class="text-2xl font-bold text-white mb-1">역할 제목</h1>
                                        
                                        <!-- 이미지 역할일 때만 표시 -->
                                        <div id="roleImageContainer" class="hidden flex-1 w-full flex items-center justify-center">
                                            <img id="mainRoleImage" 
                                                 src="" 
                                                 alt="역할 이미지" 
                                                 class="max-w-[75%] max-h-[75%] object-contain rounded-lg">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 카드 뒷면 -->
                                <div class="card-face card-back">
                                    <!-- 컨텐츠 영역 (전체 공간 사용) -->
                                    <div class="card-back-content">
                                        <div id="detailMissions">
                                            <!-- 활동방법 안내가 JavaScript로 동적 설정됩니다 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. 학습안내 (플립카드) -->
            <div class="grid-item notice-board learning-guide-flip-card" id="learningGuideFlipCard" onclick="toggleLearningGuideCard()">
                <div class="learning-guide-flip-inner">
                    <!-- 앞면: 기본 학습안내 상태 -->
                    <div class="learning-guide-front">
                        <h3 class="font-bold mb-2 text-center text-gray-700" style="font-size: 1.4rem;">📢 학습안내</h3>
                        <div class="flex-1 flex flex-col justify-center items-center">
                            <div id="fixedNoticeBoard" class="space-y-4 notice-text w-full">
                                <!-- 고정공지사항이 없을 때 표시 -->
                                <div class="text-center text-gray-500 py-4">
                                    <i class="fas fa-book-open text-3xl mb-2 text-blue-400"></i>
                                    <p style="font-size: 0.8rem;">클릭하여 자료링크 확인</p>
                                    <div class="mt-2">
                                        <i class="fas fa-mouse-pointer text-blue-500 animate-bounce"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 뒷면: 상세 학습안내 내용 -->
                    <div class="learning-guide-back">
                        <div class="h-full flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-white" style="font-size: 1.4rem;">🔗 자료링크</h3>
                                <button onclick="event.stopPropagation(); toggleLearningGuideCard()" class="text-white hover:text-gray-200 transition-colors opacity-80 hover:opacity-100">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto">
                                <div id="learningGuideContent" class="text-white space-y-3">
                                    <!-- 학습안내 내용이 여기에 로드됩니다 -->
                                    <div class="text-center py-8">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>학습안내를 불러오는 중...</p>
                                    </div>
                                </div>
                                
                                <!-- 새로고침 버튼 -->
                                <div class="mt-4 text-center">
                                    <button onclick="event.stopPropagation(); loadLearningGuideContent()" 
                                            class="text-white hover:text-white text-sm bg-white bg-opacity-15 hover:bg-opacity-25 px-3 py-1 rounded transition-all">
                                        <i class="fas fa-sync-alt mr-1"></i>새로고침
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. 선생님말씀 (개인 메시지함) - 플립 카드 구조 -->
            <div class="grid-item teacher-message">
                <h3 class="font-bold mb-2 text-center text-gray-700" style="font-size: 1.4rem;">📮 선생님 쪽지함</h3>
                
                <!-- 메시지 플립 카드 -->
                <div class="message-flip-card" id="messageFlipCard">
                    <div class="message-flip-inner">
                        <!-- 카드 앞면: 메시지 목록 -->
                        <div class="message-card-front">
                            <div class="flex-1 overflow-y-auto" style="max-height: 100%; height: 100%;">
                                <div id="personalMessagesContainer" class="p-0.5" style="height: 100%;">
                                    <!-- Messages will be loaded here -->
                                    <div class="text-center text-gray-400 py-6 flex flex-col items-center justify-center" style="height: 100%;">
                                        <i class="fas fa-envelope text-4xl mb-3 text-gray-300"></i>
                                        <p style="font-size: 0.95rem; font-weight: 500;">받은 메시지가 없습니다</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 카드 뒷면: 답장 작성 -->
                        <div class="message-card-back cursor-pointer" onclick="flipMessageCard()">
                            <div class="h-full flex flex-col justify-between" onclick="event.stopPropagation()">
                                <!-- 답장 내용 입력 -->
                                <textarea id="replyContent" 
                                          rows="4" 
                                          class="w-full px-3 py-2.5 bg-white bg-opacity-95 border border-white border-opacity-60 rounded-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-70 resize-none" 
                                          style="font-size: 0.9rem; line-height: 1.3; min-height: 100px; max-height: 140px;"></textarea>
                                
                                <!-- 버튼 영역 -->
                                <div class="flex justify-center mt-2">
                                    <button onclick="sendReply()" class="bg-white bg-opacity-40 backdrop-blur text-white py-1 px-3 rounded-lg hover:bg-opacity-50 transition text-xs font-bold border border-white border-opacity-40 shadow-md">
                                        <i class="fas fa-paper-plane mr-1 text-xs"></i>답장 보내기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Reply Section for compatibility (기존 코드 호환성 유지) -->
                <div id="replySection" class="hidden"></div>
            </div>

        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
                <p class="text-xl text-gray-700">역할을 확인하는 중...</p>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="text-center">
                    <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">확인 실패</h3>
                    <p class="text-xl text-gray-600 mb-6" id="errorMessage">학번과 이름을 다시 확인해주세요.</p>
                    <button onclick="closeError()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">
                        확인
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 김밥추가 경고 모달 -->
    <div id="kimbapWarningModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-5xl text-yellow-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">김밥추가 확인</h3>
                    <p class="text-gray-600 mb-6 leading-relaxed">
                        김밥 추가의 경우 선생님이 미리 허락한 경우만 가능합니다.<br>
                        허락없이 추가한 경우 선생님이 부르거나 취소시킬 수 있습니다.
                    </p>
                    <div class="flex space-x-3">
                        <button onclick="cancelKimbapAdd()" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition">
                            취소
                        </button>
                        <button onclick="confirmKimbapAdd()" class="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition">
                            확인
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase 초기화 단순화 -->
    <script>
        console.log('[Supabase Inline] 초기화 스크립트 시작');
        
        let globalSupabaseClient = null;
        
        // DOM 로드 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Supabase Inline] DOM 로드 완료, 초기화 시도');
            
            function initializeSupabaseInline() {
                if (typeof window.supabase !== 'undefined' && typeof SUPABASE_URL !== 'undefined') {
                    try {
                        globalSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('[Supabase Inline] 초기화 성공');
                        
                        // 커스텀 이벤트 발송
                        window.dispatchEvent(new CustomEvent('supabaseInitialized', { 
                            detail: { client: globalSupabaseClient } 
                        }));
                        
                        return true;
                    } catch (error) {
                        console.error('[Supabase Inline] 초기화 오류:', error);
                        return false;
                    }
                } else {
                    console.log('[Supabase Inline] window.supabase 아직 준비 안됨');
                    return false;
                }
            }
            
            // 즐시 초기화 시도
            if (!initializeSupabaseInline()) {
                // 1초 후 다시 시도
                setTimeout(() => {
                    if (!initializeSupabaseInline()) {
                        console.warn('[Supabase Inline] 초기화 2번 실패 - 로컬 모드로 진행');
                    }
                    console.log('[Supabase Inline] 초기화 완료');
                }, 1000);
            } else {
                console.log('[Supabase Inline] 초기화 완룼');
            }
        });
    </script>
    
    <!-- 기본 스크립트 로드 -->
    <script src="static/supabase-config.js"></script>
    <script src="static/api-wrapper.js"></script>
    <script src="static/supabase-api.js"></script>
    <script src="static/main.js"></script>
    <script src="static/student.js"></script>
    <script src="static/student-stage-settings.js"></script>
    <!-- Simple Point System (2025-01-19) - 모든 포인트 기능 대체 및 문제 차단 -->
    <script>
        console.log('🚀 [HTML] JavaScript 파일들 로드 완료!');
        console.log('🔍 [HTML] toggleDailyTasksCard 함수 확인:', typeof window.toggleDailyTasksCard);
    </script>
    <script>
        // student.js 로드 직후 즉시 문제 함수 차단
        window.checkForNewTeacherPoints = function() { return; };
        window.showTeacherPointNotification = function() { return; };
        window.checkForTeacherPoints = function() { return; };
        window.refreshStudentPoints = function() { return; };
        if (window.teacherPointCheckInterval) {
            clearInterval(window.teacherPointCheckInterval);
        }
        console.log('[Emergency] 문제 함수 즉시 차단');
    </script>

    <!-- 포인트 새로고침 상태 표시기 (백그라운드 모드) -->
    <div id="pointRefreshIndicator" class="fixed bottom-4 right-4 z-40 bg-white border border-gray-300 rounded-lg shadow-lg p-3 text-sm" style="display: none; opacity: 0; pointer-events: none;">
        <div class="flex items-center space-x-2">
            <div id="refreshIcon" class="w-4 h-4">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
            </div>
            <div>
                <div id="refreshStatus" class="font-medium text-gray-700">포인트 새로고침</div>
                <div id="refreshTime" class="text-xs text-gray-500">준비 중...</div>
            </div>
        </div>
    </div>

</body>
</html>