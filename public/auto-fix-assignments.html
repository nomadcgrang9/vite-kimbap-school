<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë™ ë°°ì • ì •ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">ğŸ”§ ìë™ ë°°ì • ì •ë¦¬ ì‹¤í–‰ ì¤‘</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ ì‘ì—… ì§„í–‰ ìƒí™©</h2>
            <div id="statusLog" class="bg-gray-900 text-green-400 p-4 rounded text-sm font-mono h-96 overflow-y-auto"></div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ¯ ë‹¤ìŒ ë‹¨ê³„</h2>
            <div id="nextSteps" class="text-gray-600">
                ì‘ì—… ì™„ë£Œ í›„ ë‹¤ìŒ ë‹¨ê³„ê°€ í‘œì‹œë©ë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <script src="static/supabase-config.js"></script>
    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                success: 'text-cyan-400 font-bold',
                error: 'text-red-400 font-bold',
                warning: 'text-yellow-400'
            };
            
            logEl.innerHTML += `<div class="${colors[type] || colors.info}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log('[ìë™ì •ë¦¬]', message);
        }

        async function fixDuplicateAssignments() {
            log('ğŸš€ ìë™ ì¤‘ë³µ ë°°ì • ì •ë¦¬ ì‹œì‘', 'success');
            
            try {
                // 1ë‹¨ê³„: í˜„ì¬ ìƒíƒœ í™•ì¸
                log('ğŸ“Š 1ë‹¨ê³„: í˜„ì¬ ë°°ì • ìƒíƒœ í™•ì¸ ì¤‘...');
                
                const { data: assignments, error: fetchError } = await supabase
                    .from('assignments')
                    .select('*')
                    .eq('student_id', '3127')
                    .order('assigned_at', { ascending: false });

                if (fetchError) throw fetchError;

                log(`ë°œê²¬ëœ ë°°ì •: ${assignments.length}ê°œ`);
                
                if (assignments.length === 0) {
                    log('âŒ ë°°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                if (assignments.length === 1) {
                    log('âœ… ì´ë¯¸ ì¤‘ë³µ ë°°ì •ì´ ì—†ìŠµë‹ˆë‹¤.', 'success');
                    log(`í˜„ì¬ ë°°ì •: ${assignments[0].role_name} (${assignments[0].role_type})`);
                    showNextSteps(true);
                    return;
                }

                // 2ë‹¨ê³„: ìµœì‹  ë°°ì • ì‹ë³„
                log('ğŸ¯ 2ë‹¨ê³„: ìµœì‹  ë°°ì • ì‹ë³„ ì¤‘...');
                
                const latestAssignment = assignments[0]; // ì´ë¯¸ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë¨
                const duplicateAssignments = assignments.slice(1);

                log(`âœ… ìœ ì§€í•  ë°°ì •: ${latestAssignment.role_name} (${latestAssignment.role_type})`, 'success');
                log(`ë°°ì • ì‹œê°„: ${new Date(latestAssignment.assigned_at).toLocaleString()}`);
                log(`âŒ ì‚­ì œí•  ë°°ì •: ${duplicateAssignments.length}ê°œ`, 'warning');

                // 3ë‹¨ê³„: ì¤‘ë³µ ë°°ì • ì‚­ì œ
                log('ğŸ—‘ï¸ 3ë‹¨ê³„: ì¤‘ë³µ ë°°ì • ì‚­ì œ ì‹œì‘...');
                
                let deletedCount = 0;
                for (const assignment of duplicateAssignments) {
                    try {
                        const { error: deleteError } = await supabase
                            .from('assignments')
                            .delete()
                            .eq('id', assignment.id);

                        if (deleteError) throw deleteError;
                        
                        deletedCount++;
                        log(`âœ… ì‚­ì œ ì™„ë£Œ: ${assignment.role_name} (ID: ${assignment.id.slice(0, 8)}...)`);
                        
                    } catch (error) {
                        log(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${assignment.role_name} - ${error.message}`, 'error');
                    }
                }

                // 4ë‹¨ê³„: ê²°ê³¼ í™•ì¸
                log('ğŸ” 4ë‹¨ê³„: ê²°ê³¼ í™•ì¸ ì¤‘...');
                
                const { data: finalCheck, error: checkError } = await supabase
                    .from('assignments')
                    .select('*')
                    .eq('student_id', '3127');

                if (checkError) throw checkError;

                log('='.repeat(50), 'success');
                log('ğŸ‰ ìë™ ì •ë¦¬ ì‘ì—… ì™„ë£Œ!', 'success');
                log(`âœ… ì‚­ì œëœ ë°°ì •: ${deletedCount}ê°œ`, 'success');
                log(`âœ… ë‚¨ì€ ë°°ì •: ${finalCheck.length}ê°œ`, 'success');
                
                if (finalCheck.length > 0) {
                    const remaining = finalCheck[0];
                    log(`ğŸ“Œ ìµœì¢… ë°°ì •: ${remaining.role_name} (${remaining.role_type})`, 'success');
                }
                
                log('='.repeat(50), 'success');

                // ë‹¤ìŒ ë‹¨ê³„ í‘œì‹œ
                showNextSteps(true);
                
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error('ìë™ ì •ë¦¬ ì˜¤ë¥˜:', error);
                showNextSteps(false);
            }
        }

        function showNextSteps(success) {
            const nextStepsEl = document.getElementById('nextSteps');
            
            if (success) {
                nextStepsEl.innerHTML = `
                    <div class="space-y-3">
                        <div class="text-green-600 font-semibold text-lg">âœ… ì¤‘ë³µ ë°°ì • ì •ë¦¬ ì™„ë£Œ!</div>
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="font-semibold mb-2">ğŸ¯ ë‹¤ìŒ ë‹¨ê³„: í•™ìƒí˜ì´ì§€ í…ŒìŠ¤íŠ¸</div>
                            <div class="space-y-2">
                                <div>1. ì•„ë˜ ë§í¬ë¡œ í•™ìƒí˜ì´ì§€ ì ‘ì†:</div>
                                <a href="student.html?studentId=3127&studentName=í…ŒìŠ¤íŠ¸" 
                                   target="_blank"
                                   class="block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-center">
                                    ğŸ‘¤ 3127 í•™ìƒ í˜ì´ì§€ë¡œ ì´ë™
                                </a>
                                <div class="text-sm text-gray-600">
                                    â†’ ì—­í• ë°°ì • ì¹´ë“œì— "ì—­í•  1"ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸<br>
                                    â†’ í”Œë¦½ì¹´ë“œê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded">
                            <div class="font-semibold mb-2">ğŸ” ì¶”ê°€ í™•ì¸ ë„êµ¬:</div>
                            <a href="debug-database-state.html" 
                               target="_blank"
                               class="block bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 text-center">
                                ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ ì¬í™•ì¸
                            </a>
                        </div>
                    </div>
                `;
            } else {
                nextStepsEl.innerHTML = `
                    <div class="text-red-600">
                        <div class="font-semibold">âŒ ì‘ì—… ì‹¤íŒ¨</div>
                        <div>ìˆ˜ë™ìœ¼ë¡œ ì¤‘ë³µ ë°°ì • ì •ë¦¬ ë„êµ¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</div>
                        <a href="fix-duplicate-assignments.html" 
                           target="_blank"
                           class="block bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-center mt-3">
                            ğŸ”§ ìˆ˜ë™ ì •ë¦¬ ë„êµ¬ë¡œ ì´ë™
                        </a>
                    </div>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                fixDuplicateAssignments();
            }, 1500);
        });
    </script>
</body>
</html>