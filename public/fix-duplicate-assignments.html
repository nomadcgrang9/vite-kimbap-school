<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¤‘ë³µ ë°°ì • ì •ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">ğŸ”§ ì¤‘ë³µ ë°°ì • ì •ë¦¬</h1>
        
        <!-- í˜„ì¬ ìƒíƒœ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š í˜„ì¬ ì¤‘ë³µ ë°°ì • ìƒíƒœ</h2>
            <div id="currentState" class="text-gray-500">í™•ì¸ ì¤‘...</div>
        </div>

        <!-- ì •ë¦¬ ì˜µì…˜ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">âš™ï¸ ì •ë¦¬ ì˜µì…˜</h2>
            <div class="space-y-3">
                <button onclick="keepLatestOnly()" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full">
                    ğŸ“ ìµœì‹  ë°°ì •ë§Œ ìœ ì§€ (ê°€ì¥ ìµœê·¼ ê²ƒ 1ê°œë§Œ ë‚¨ê¹€)
                </button>
                <button onclick="keepImageRoleOnly()" 
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 w-full">
                    ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—­í• ë§Œ ìœ ì§€ (role_type='image'ì¸ ê²ƒë§Œ ë‚¨ê¹€)
                </button>
                <button onclick="deleteAllAssignments()" 
                        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full">
                    ğŸ—‘ï¸ ëª¨ë“  ë°°ì • ì‚­ì œ (ì™„ì „ ì´ˆê¸°í™”)
                </button>
                <button onclick="keepSpecificRole()" 
                        class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 w-full">
                    ğŸ¯ íŠ¹ì • ì—­í• ë§Œ ìœ ì§€ (ìˆ˜ë™ ì„ íƒ)
                </button>
            </div>
        </div>

        <!-- ì‘ì—… ë¡œê·¸ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ ì‘ì—… ë¡œê·¸</h2>
            <div id="workLog" class="bg-gray-50 p-3 rounded text-sm font-mono h-40 overflow-y-auto"></div>
        </div>
    </div>

    <script src="static/supabase-config.js"></script>
    <script>
        let allAssignments = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkCurrentState();
            }, 1000);
        });

        function log(message) {
            const logEl = document.getElementById('workLog');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log('[ì •ë¦¬]', message);
        }

        async function checkCurrentState() {
            log('í˜„ì¬ ë°°ì • ìƒíƒœ í™•ì¸ ì¤‘...');
            
            try {
                const { data, error } = await supabase
                    .from('assignments')
                    .select('*')
                    .eq('student_id', '3127')
                    .order('assigned_at', { ascending: false });

                if (error) throw error;

                allAssignments = data;
                
                const stateEl = document.getElementById('currentState');
                stateEl.innerHTML = `
                    <div class="mb-4">
                        <strong>í•™ìƒ 3127ì˜ ë°°ì • í˜„í™©:</strong>
                        <div class="text-lg font-semibold text-red-600">${data.length}ê°œì˜ ì¤‘ë³µ ë°°ì • ë°œê²¬</div>
                    </div>
                    <div class="space-y-2">
                        ${data.map((assignment, index) => `
                            <div class="border-l-4 border-blue-500 pl-3 py-2 bg-gray-50">
                                <div class="font-semibold">${index + 1}. ${assignment.role_name}</div>
                                <div class="text-sm text-gray-600">
                                    íƒ€ì…: ${assignment.role_type} | 
                                    ë°°ì • ì‹œê°„: ${new Date(assignment.assigned_at).toLocaleString()}
                                </div>
                                <div class="text-xs text-gray-500">ID: ${assignment.id}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                log(`${data.length}ê°œì˜ ì¤‘ë³µ ë°°ì • ë°œê²¬`);
                
            } catch (error) {
                log(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        async function keepLatestOnly() {
            log('ìµœì‹  ë°°ì •ë§Œ ìœ ì§€í•˜ëŠ” ì‘ì—… ì‹œì‘...');
            
            try {
                if (allAssignments.length === 0) {
                    log('ë°°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê°€ì¥ ìµœì‹  ë°°ì • 1ê°œ ì„ íƒ
                const latestAssignment = allAssignments[0]; // ì´ë¯¸ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë¨
                const toDelete = allAssignments.slice(1); // ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œ

                log(`ìœ ì§€í•  ë°°ì •: ${latestAssignment.role_name} (${latestAssignment.role_type})`);
                log(`ì‚­ì œí•  ë°°ì •: ${toDelete.length}ê°œ`);

                // ë‚˜ë¨¸ì§€ ë°°ì •ë“¤ ì‚­ì œ
                for (const assignment of toDelete) {
                    const { error } = await supabase
                        .from('assignments')
                        .delete()
                        .eq('id', assignment.id);

                    if (error) throw error;
                    log(`ì‚­ì œ ì™„ë£Œ: ${assignment.role_name}`);
                }

                log(`âœ… ì‘ì—… ì™„ë£Œ! ${latestAssignment.role_name}ë§Œ ìœ ì§€ë¨`);
                
                // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                await checkCurrentState();
                
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('ì‘ì—… ì˜¤ë¥˜:', error);
            }
        }

        async function keepImageRoleOnly() {
            log('ì´ë¯¸ì§€ ì—­í• ë§Œ ìœ ì§€í•˜ëŠ” ì‘ì—… ì‹œì‘...');
            
            try {
                const imageAssignments = allAssignments.filter(a => a.role_type === 'image');
                const nonImageAssignments = allAssignments.filter(a => a.role_type !== 'image');

                if (imageAssignments.length === 0) {
                    log('âŒ ì´ë¯¸ì§€ ì—­í• ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ìµœì‹  ì´ë¯¸ì§€ ì—­í•  1ê°œë§Œ ìœ ì§€
                const keepAssignment = imageAssignments[0];
                const toDelete = [...imageAssignments.slice(1), ...nonImageAssignments];

                log(`ìœ ì§€í•  ë°°ì •: ${keepAssignment.role_name} (ì´ë¯¸ì§€)`);
                log(`ì‚­ì œí•  ë°°ì •: ${toDelete.length}ê°œ`);

                // ë‚˜ë¨¸ì§€ ì‚­ì œ
                for (const assignment of toDelete) {
                    const { error } = await supabase
                        .from('assignments')
                        .delete()
                        .eq('id', assignment.id);

                    if (error) throw error;
                    log(`ì‚­ì œ ì™„ë£Œ: ${assignment.role_name}`);
                }

                log(`âœ… ì‘ì—… ì™„ë£Œ! ì´ë¯¸ì§€ ì—­í• ë§Œ ìœ ì§€ë¨`);
                
                // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                await checkCurrentState();
                
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('ì‘ì—… ì˜¤ë¥˜:', error);
            }
        }

        async function deleteAllAssignments() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°°ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            log('ëª¨ë“  ë°°ì • ì‚­ì œ ì‘ì—… ì‹œì‘...');
            
            try {
                const { error } = await supabase
                    .from('assignments')
                    .delete()
                    .eq('student_id', '3127');

                if (error) throw error;

                log(`âœ… ëª¨ë“  ë°°ì • ì‚­ì œ ì™„ë£Œ (${allAssignments.length}ê°œ)`);
                
                // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                await checkCurrentState();
                
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
            }
        }

        async function keepSpecificRole() {
            if (allAssignments.length === 0) {
                log('ë°°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì‚¬ìš©ìì—ê²Œ ì„ íƒ ì˜µì…˜ ì œì‹œ
            const options = allAssignments.map((assignment, index) => 
                `${index}: ${assignment.role_name} (${assignment.role_type}) - ${new Date(assignment.assigned_at).toLocaleString()}`
            ).join('\n');

            const choice = prompt(`ìœ ì§€í•  ë°°ì •ì„ ì„ íƒí•˜ì„¸ìš” (ë²ˆí˜¸ ì…ë ¥):\n${options}`);
            
            if (choice === null) return; // ì·¨ì†Œ
            
            const choiceIndex = parseInt(choice);
            if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= allAssignments.length) {
                alert('ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.');
                return;
            }

            log(`íŠ¹ì • ì—­í•  ìœ ì§€ ì‘ì—… ì‹œì‘: ${allAssignments[choiceIndex].role_name}`);
            
            try {
                const keepAssignment = allAssignments[choiceIndex];
                const toDelete = allAssignments.filter((_, index) => index !== choiceIndex);

                log(`ìœ ì§€í•  ë°°ì •: ${keepAssignment.role_name}`);
                log(`ì‚­ì œí•  ë°°ì •: ${toDelete.length}ê°œ`);

                // ë‚˜ë¨¸ì§€ ì‚­ì œ
                for (const assignment of toDelete) {
                    const { error } = await supabase
                        .from('assignments')
                        .delete()
                        .eq('id', assignment.id);

                    if (error) throw error;
                    log(`ì‚­ì œ ì™„ë£Œ: ${assignment.role_name}`);
                }

                log(`âœ… ì‘ì—… ì™„ë£Œ! ${keepAssignment.role_name}ë§Œ ìœ ì§€ë¨`);
                
                // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                await checkCurrentState();
                
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('ì‘ì—… ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>
</html>