<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>역할배정 관리 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .tab-button.active {
            background-color: #6366f1;
            color: white;
            border-bottom: 3px solid #4f46e5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .action-button {
            transition: all 0.3s ease;
        }
        
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background-color: #10b981; }
        .status-inactive { background-color: #6b7280; }
        .status-error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen">
    <!-- 헤더 -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-users-cog text-indigo-600 mr-3"></i>
                        역할배정 관리 시스템
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="text-sm">
                        <span class="status-indicator status-active"></span>
                        연결됨
                    </div>
                    <a href="admin-v2.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-1"></i>
                        관리자 페이지로 돌아가기
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- 탭 네비게이션 -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-0">
                    <button id="sessionTab" 
                            onclick="switchTab('session')" 
                            class="tab-button active px-6 py-4 text-sm font-medium text-gray-700 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-300 transition-colors">
                        <i class="fas fa-cogs mr-2"></i>
                        세션 관리
                    </button>
                    <button id="assignmentTab" 
                            onclick="switchTab('assignment')" 
                            class="tab-button px-6 py-4 text-sm font-medium text-gray-700 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-300 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>
                        배정 관리
                    </button>
                    <button id="statusTab" 
                            onclick="switchTab('status')" 
                            class="tab-button px-6 py-4 text-sm font-medium text-gray-700 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-300 transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>
                        배정 현황
                    </button>
                </nav>
            </div>
        </div>

        <!-- 세션 관리 탭 -->
        <div id="sessionContent" class="tab-content active">
            <div class="section-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-plus-circle text-indigo-600 mr-2"></i>
                        역할 세션 관리
                    </h2>
                    <button onclick="showCreateSessionModal()" 
                            class="action-button bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>
                        새 세션 생성
                    </button>
                </div>
                
                <!-- 세션 목록 -->
                <div id="sessionsList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <div>세션 목록을 불러오는 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 배정 관리 탭 -->
        <div id="assignmentContent" class="tab-content">
            <div class="section-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-user-check text-green-600 mr-2"></i>
                        학급별 역할 배정
                    </h2>
                </div>
                
                <!-- 배정 인터페이스 -->
                <div id="assignmentInterface">
                    <!-- 1단계: 세션 선택 -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs mr-2">1단계</span>
                            배정할 세션 선택
                        </label>
                        <select id="assignmentSessionSelect" onchange="selectAssignmentSession()" 
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">세션을 선택하세요</option>
                        </select>
                    </div>
                    
                    <!-- 2단계: 대상학급 입력 (세션 선택 후 활성화) -->
                    <div id="targetClassSection" class="hidden bg-blue-50 rounded-lg p-4 mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mr-2">2단계</span>
                            대상 학급 입력
                        </label>
                        <div class="flex space-x-3">
                            <input type="text" id="assignmentTargetClass" 
                                   placeholder="예: 3-1 (3학년 1반), 4학년 (4학년 전체)" 
                                   class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="startAssignment()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 whitespace-nowrap">
                                배정 시작
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            입력 예시: "3-1" → 3학년 1반, "4학년" → 4학년 전체 (자동으로 1~27번 학생에게 배정)
                        </p>
                    </div>
                    
                    <!-- 3단계: 배정 결과 및 개별 수정 -->
                    <div id="assignmentResultSection" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">배정 결과</h3>
                            <div class="flex space-x-2">
                                <button onclick="shuffleAssignments()" 
                                        class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 text-sm">
                                    <i class="fas fa-random mr-1"></i>재배정
                                </button>
                                <button onclick="saveAssignments()" 
                                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                                    <i class="fas fa-save mr-1"></i>저장
                                </button>
                            </div>
                        </div>
                        <div id="assignmentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- 배정 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 배정 현황 탭 -->
        <div id="statusContent" class="tab-content">
            <div class="section-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-analytics text-purple-600 mr-2"></i>
                        배정 현황 및 통계
                    </h2>
                    <div class="flex space-x-2">
                        <button onclick="refreshStatus()" 
                                class="action-button bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-sync-alt mr-2"></i>
                            새로고침
                        </button>
                        <button onclick="exportAssignments()" 
                                class="action-button bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                            <i class="fas fa-download mr-2"></i>
                            CSV 내보내기
                        </button>
                    </div>
                </div>
                
                <!-- 현황 대시보드 -->
                <div id="statusDashboard">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <div>배정 현황을 불러오는 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <i class="fas fa-spinner fa-spin text-3xl text-indigo-600 mb-4"></i>
            <div class="text-lg font-medium">처리 중...</div>
        </div>
    </div>

    <!-- 알림 컨테이너 -->
    <div id="notifications" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <script src="static/supabase-config.js"></script>
    <script>
        // 전역 변수
        let sessions = [];
        let assignments = [];
        let students = [];
        let currentTab = 'session';

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[RoleManagement] 페이지 초기화 시작');
            
            setTimeout(() => {
                initializeRoleManagement();
            }, 1000);
        });

        async function initializeRoleManagement() {
            console.log('[RoleManagement] 초기화 시작');
            
            try {
                // 연결 상태 확인
                await checkConnection();
                
                // 기본 데이터 로드
                await loadAllData();
                
                // 현재 탭 콘텐츠 로드
                await loadTabContent(currentTab);
                
                showNotification('시스템이 준비되었습니다', 'success');
                
            } catch (error) {
                console.error('[RoleManagement] 초기화 오류:', error);
                showNotification(`초기화 오류: ${error.message}`, 'error');
            }
        }

        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            
            try {
                if (!supabase) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다');
                }

                const { count, error } = await supabase
                    .from('sessions')
                    .select('*', { count: 'exact', head: true });

                if (error) throw error;

                statusEl.innerHTML = `
                    <span class="status-indicator status-active"></span>
                    연결됨 (${count}개 세션)
                `;
                
            } catch (error) {
                console.error('[Connection] 연결 오류:', error);
                statusEl.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    연결 실패
                `;
            }
        }

        async function loadAllData() {
            console.log('[Data] 전체 데이터 로드 시작');
            
            try {
                // 병렬로 데이터 로드
                const [sessionsResult, assignmentsResult, studentsResult] = await Promise.all([
                    supabase.from('sessions').select('*').order('created_at', { ascending: false }),
                    supabase.from('assignments').select('*').order('assigned_at', { ascending: false }),
                    supabase.from('students').select('*').order('created_at', { ascending: false })
                ]);

                if (sessionsResult.error) throw sessionsResult.error;
                if (assignmentsResult.error) throw assignmentsResult.error;
                if (studentsResult.error) throw studentsResult.error;

                sessions = sessionsResult.data || [];
                assignments = assignmentsResult.data || [];
                students = studentsResult.data || [];

                console.log('[Data] 로드 완료:', {
                    sessions: sessions.length,
                    assignments: assignments.length,
                    students: students.length
                });

            } catch (error) {
                console.error('[Data] 로드 오류:', error);
                throw error;
            }
        }

        function switchTab(tabName) {
            console.log('[Tab] 탭 전환:', tabName);
            
            // 탭 버튼 스타일 업데이트
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // 탭 콘텐츠 전환
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Content`).classList.add('active');

            currentTab = tabName;
            
            // 탭별 콘텐츠 로드
            loadTabContent(tabName);
        }

        async function loadTabContent(tabName) {
            console.log('[Tab] 콘텐츠 로드:', tabName);
            
            switch(tabName) {
                case 'session':
                    await loadSessionsTab();
                    break;
                case 'assignment':
                    await loadAssignmentTab();
                    break;
                case 'status':
                    await loadStatusTab();
                    break;
            }
        }

        async function loadSessionsTab() {
            console.log('[Sessions] 세션 탭 로드');
            
            const listEl = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <div class="text-lg font-medium">세션이 없습니다</div>
                        <div class="text-sm">새 세션을 생성해보세요</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = sessions.map(session => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-indigo-300 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-900">${session.name}</h3>
                            <div class="text-sm text-gray-600 mt-1">
                                <span class="inline-flex items-center">
                                    <i class="fas fa-calendar mr-1"></i>
                                    ${new Date(session.created_at).toLocaleDateString()}
                                </span>
                                <span class="ml-4 inline-flex items-center">
                                    <i class="fas fa-users mr-1"></i>
                                    ${session.target_class}
                                </span>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                ${session.activity_instructions || '활동방법 안내 없음'}
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editSession('${session.id}')" 
                                    class="text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSession('${session.id}')" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="text-xs text-gray-500">
                            역할 수: ${JSON.parse(session.missions || '[]').length}개
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadAssignmentTab() {
            console.log('[Assignment] 배정 탭 로드');
            
            // 세션 선택 드롭다운 채우기
            const sessionSelect = document.getElementById('assignmentSessionSelect');
            sessionSelect.innerHTML = '<option value="">세션을 선택하세요</option>';
            
            if (sessions.length === 0) {
                sessionSelect.innerHTML += '<option value="" disabled>사용 가능한 세션이 없습니다</option>';
                return;
            }
            
            sessions.forEach(session => {
                sessionSelect.innerHTML += `
                    <option value="${session.id}">
                        ${session.name} (역할 ${JSON.parse(session.missions).length}개)
                    </option>
                `;
            });
            
            // 상태 초기화
            currentAssignmentSession = null;
            currentAssignments = [];
            document.getElementById('targetClassSection').classList.add('hidden');
            document.getElementById('assignmentResultSection').classList.add('hidden');
        }

        async function onAssignmentSessionChange() {
            const sessionSelect = document.getElementById('sessionSelect');
            const selectedSessionId = sessionSelect.value;
            const summaryEl = document.getElementById('assignmentSummary');
            const detailsEl = document.getElementById('assignmentDetails');

            if (!selectedSessionId) {
                summaryEl.innerHTML = '세션을 선택하면 배정 현황이 표시됩니다';
                detailsEl.classList.add('hidden');
                return;
            }

            const session = sessions.find(s => s.id === selectedSessionId);
            if (!session) return;

            console.log('[Assignment] 세션 변경:', session.name);

            // 배정 현황 계산
            const sessionAssignments = assignments.filter(a => a.session_id === selectedSessionId);
            const targetClass = session.target_class;
            const classStudents = students.filter(s => s.class_name === targetClass);
            const roles = JSON.parse(session.missions || '[]');

            // 요약 정보 표시
            const assignedCount = sessionAssignments.length;
            const totalStudents = classStudents.length;
            const assignmentRate = totalStudents > 0 ? Math.round((assignedCount / totalStudents) * 100) : 0;

            summaryEl.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${assignedCount}</div>
                        <div class="text-xs text-gray-500">배정 완료</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${totalStudents - assignedCount}</div>
                        <div class="text-xs text-gray-500">미배정</div>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <div class="flex justify-between text-xs">
                        <span>진행률</span>
                        <span>${assignmentRate}%</span>
                    </div>
                    <div class="mt-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: ${assignmentRate}%"></div>
                    </div>
                </div>
            `;

            // 상세 테이블 표시
            await loadAssignmentTable(selectedSessionId, session, sessionAssignments, classStudents, roles);
            detailsEl.classList.remove('hidden');
        }

        async function loadAssignmentTable(sessionId, session, sessionAssignments, classStudents, roles) {
            const tableEl = document.getElementById('assignmentTable');
            
            if (classStudents.length === 0) {
                tableEl.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div>${session.target_class} 학생이 없습니다</div>
                    </div>
                `;
                return;
            }

            // 학생별 배정 상태 매핑
            const assignmentMap = new Map();
            sessionAssignments.forEach(a => {
                assignmentMap.set(a.student_id, a);
            });

            const tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th class="px-3 py-2 text-left">학생명</th>
                                <th class="px-3 py-2 text-left">배정된 역할</th>
                                <th class="px-3 py-2 text-left">역할 설명</th>
                                <th class="px-3 py-2 text-left">상태</th>
                                <th class="px-3 py-2 text-left">배정일시</th>
                                <th class="px-3 py-2 text-center">작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${classStudents.map(student => {
                                const assignment = assignmentMap.get(student.id);
                                const isAssigned = !!assignment;
                                
                                return `
                                    <tr class="border-t hover:bg-gray-50">
                                        <td class="px-3 py-2">
                                            ${isAssigned ? 
                                                `<input type="checkbox" class="assignment-checkbox" value="${assignment.id}">` :
                                                '<span class="text-gray-300">-</span>'
                                            }
                                        </td>
                                        <td class="px-3 py-2 font-medium">${student.name}</td>
                                        <td class="px-3 py-2">
                                            ${isAssigned ? 
                                                `<span class="font-medium text-indigo-700">${assignment.role_name}</span>` :
                                                '<span class="text-gray-400">미배정</span>'
                                            }
                                        </td>
                                        <td class="px-3 py-2">
                                            ${isAssigned ? 
                                                `<span class="text-gray-600">${assignment.role_description || '-'}</span>` :
                                                '<span class="text-gray-300">-</span>'
                                            }
                                        </td>
                                        <td class="px-3 py-2">
                                            ${isAssigned ? 
                                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">배정됨</span>' :
                                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800">미배정</span>'
                                            }
                                        </td>
                                        <td class="px-3 py-2 text-gray-500">
                                            ${isAssigned ? 
                                                new Date(assignment.assigned_at).toLocaleDateString() :
                                                '-'
                                            }
                                        </td>
                                        <td class="px-3 py-2 text-center">
                                            ${isAssigned ? 
                                                `<button onclick="editSingleAssignment('${assignment.id}')" 
                                                         class="text-indigo-600 hover:text-indigo-800 mr-2">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteSingleAssignment('${assignment.id}')" 
                                                        class="text-red-600 hover:text-red-800">
                                                    <i class="fas fa-trash"></i>
                                                </button>` :
                                                `<button onclick="assignSingleStudent('${student.id}', '${sessionId}')" 
                                                         class="text-green-600 hover:text-green-800">
                                                    <i class="fas fa-plus"></i>
                                                </button>`
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            tableEl.innerHTML = tableHTML;
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });

            updateEditButton();
        }

        function updateEditButton() {
            const checkedBoxes = document.querySelectorAll('.assignment-checkbox:checked');
            const editButton = document.getElementById('editSelectedButton');
            
            if (editButton) {
                editButton.disabled = checkedBoxes.length === 0;
            }
        }

        // 체크박스 변경 이벤트 리스너 등록
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('assignment-checkbox')) {
                updateEditButton();
            }
        });

        function refreshAssignmentDetails() {
            const sessionSelect = document.getElementById('sessionSelect');
            if (sessionSelect && sessionSelect.value) {
                onAssignmentSessionChange();
            }
        }

        async function loadStatusTab() {
            console.log('[Status] 현황 탭 로드');
            
            const dashboardEl = document.getElementById('statusDashboard');
            
            // 통계 계산
            const totalAssignments = assignments.length;
            const uniqueStudents = new Set(assignments.map(a => a.student_id)).size;
            const activeSessions = sessions.filter(s => s.status === 'active').length;

            dashboardEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-indigo-50 rounded-lg p-6">
                        <div class="flex items-center">
                            <i class="fas fa-tasks text-2xl text-indigo-600 mr-3"></i>
                            <div>
                                <div class="text-2xl font-bold text-indigo-900">${totalAssignments}</div>
                                <div class="text-sm text-indigo-600">총 배정 수</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-6">
                        <div class="flex items-center">
                            <i class="fas fa-users text-2xl text-green-600 mr-3"></i>
                            <div>
                                <div class="text-2xl font-bold text-green-900">${uniqueStudents}</div>
                                <div class="text-sm text-green-600">배정된 학생 수</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-6">
                        <div class="flex items-center">
                            <i class="fas fa-cogs text-2xl text-purple-600 mr-3"></i>
                            <div>
                                <div class="text-2xl font-bold text-purple-900">${activeSessions}</div>
                                <div class="text-sm text-purple-600">활성 세션 수</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-medium text-gray-900 mb-3">최근 배정 내역</h3>
                    ${assignments.slice(0, 10).map(assignment => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                            <div>
                                <span class="font-medium">${assignment.student_name}</span>
                                <span class="text-gray-600">→ ${assignment.role_name}</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                ${new Date(assignment.assigned_at).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 핵심 배정 기능 구현
        function showCreateSessionModal() {
            showCreateSessionForm();
        }

        function showBulkAssignModal() {
            showBulkAssignForm();
        }

        function showBulkAssignForm() {
            console.log('[BulkAssign] 대량 배정 모달 표시');
            
            if (sessions.length === 0) {
                showNotification('먼저 세션을 생성해주세요', 'warning');
                switchTab('session');
                return;
            }

            const modalHTML = `
                <div id="bulkAssignModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">
                                <i class="fas fa-users mr-2 text-green-600"></i>
                                학급 일괄 역할 배정
                            </h2>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            <!-- 1단계: 세션 선택 -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-medium text-gray-900 mb-3">
                                    <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-sm mr-2">1단계</span>
                                    배정할 세션 선택
                                </h3>
                                <select id="bulkSessionSelect" class="w-full border border-gray-300 rounded px-3 py-2" 
                                        onchange="onBulkSessionChange()">
                                    <option value="">세션을 선택하세요</option>
                                    ${sessions.map(s => `
                                        <option value="${s.id}" data-class="${s.target_class}">
                                            ${s.name} (${s.target_class})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            <!-- 2단계: 대상 학급 확인 -->
                            <div id="targetClassSection" class="border border-gray-200 rounded-lg p-4 hidden">
                                <h3 class="font-medium text-gray-900 mb-3">
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm mr-2">2단계</span>
                                    대상 학급 확인
                                </h3>
                                <div id="targetClassInfo" class="text-sm text-gray-600"></div>
                            </div>

                            <!-- 3단계: 역할 배정 옵션 -->
                            <div id="assignmentOptionsSection" class="border border-gray-200 rounded-lg p-4 hidden">
                                <h3 class="font-medium text-gray-900 mb-3">
                                    <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm mr-2">3단계</span>
                                    배정 옵션 설정
                                </h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">배정 방식</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="radio" name="assignmentMethod" value="random" checked 
                                                       class="mr-2">
                                                <span class="text-sm">무작위 배정 (권장)</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="assignmentMethod" value="sequential" 
                                                       class="mr-2">
                                                <span class="text-sm">순차 배정</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="assignmentMethod" value="manual" 
                                                       class="mr-2">
                                                <span class="text-sm">개별 지정</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center mb-2">
                                            <input type="checkbox" id="replaceExisting" class="mr-2">
                                            <span class="text-sm font-medium text-gray-700">기존 배정 교체</span>
                                        </label>
                                        <p class="text-xs text-gray-500">
                                            체크하면 이미 배정된 학생의 역할을 새로 배정합니다
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- 4단계: 배정 미리보기 -->
                            <div id="previewSection" class="border border-gray-200 rounded-lg p-4 hidden">
                                <h3 class="font-medium text-gray-900 mb-3">
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm mr-2">4단계</span>
                                    배정 미리보기
                                </h3>
                                <div id="assignmentPreview" class="max-h-60 overflow-y-auto">
                                    <!-- 미리보기 내용이 여기 표시됩니다 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-between">
                            <button onclick="closeBulkAssignModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                <i class="fas fa-times mr-1"></i>취소
                            </button>
                            <div class="space-x-2">
                                <button id="previewButton" onclick="generatePreview()" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50" 
                                        disabled>
                                    <i class="fas fa-eye mr-1"></i>미리보기 생성
                                </button>
                                <button id="executeButton" onclick="executeBulkAssignment()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50" 
                                        disabled>
                                    <i class="fas fa-check mr-1"></i>일괄 배정 실행
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function editSession(id) {
            const session = sessions.find(s => s.id === id);
            if (session) {
                showEditSessionForm(session);
            }
        }

        function showEditSessionForm(session) {
            const roles = JSON.parse(session.missions || '[]');
            const hasImageRoles = roles.some(role => role.type === 'image');
            const hasTextRoles = roles.some(role => role.type === 'text');
            
            console.log('[EditSession] 세션 편집:', session.name, { hasImageRoles, hasTextRoles });
            
            const modalHTML = `
                <div id="editSessionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">세션 편집</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">세션 이름</label>
                                <input type="text" id="editSessionName" value="${session.name}" 
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">대상 학급</label>
                                <input type="text" id="editSessionTargetClass" value="${session.target_class}" 
                                       placeholder="예: 3-1, 4학년, 전체"
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <p class="text-xs text-gray-500 mt-1">
                                    입력 예시: "3-1" → 3학년 1반, "4학년" → 4학년 전체
                                </p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">활동방법 안내</label>
                                <textarea id="editSessionInstructions" rows="3" 
                                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">${session.activity_instructions || ''}</textarea>
                            </div>
                            
                            <!-- 역할 정보 표시 (읽기 전용) -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">현재 역할들</h3>
                                <div class="text-sm text-gray-600 mb-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs ${hasTextRoles ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}">
                                        <i class="fas fa-font mr-1"></i>
                                        텍스트 역할: ${roles.filter(r => r.type === 'text').length}개
                                    </span>
                                    <span class="ml-2 inline-flex items-center px-2 py-1 rounded text-xs ${hasImageRoles ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                        <i class="fas fa-image mr-1"></i>
                                        이미지 역할: ${roles.filter(r => r.type === 'image').length}개
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    ※ 역할 편집은 현재 지원되지 않습니다. 필요시 세션을 삭제하고 새로 만드세요.
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="closeEditSessionModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button onclick="saveSessionEdit('${session.id}')" 
                                    class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                저장
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditSessionModal() {
            const modal = document.getElementById('editSessionModal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveSessionEdit(sessionId) {
            const name = document.getElementById('editSessionName').value.trim();
            const targetClassInput = document.getElementById('editSessionTargetClass').value.trim();
            const instructions = document.getElementById('editSessionInstructions').value.trim();
            
            if (!name) {
                showNotification('세션 이름을 입력하세요', 'error');
                return;
            }
            
            if (!targetClassInput) {
                showNotification('대상 학급을 입력하세요', 'error');
                return;
            }

            // 클래스 파싱
            const parsedClass = parseTargetClass(targetClassInput);
            if (!parsedClass) {
                showNotification('대상 학급 형식이 올바르지 않습니다', 'error');
                return;
            }

            showLoading();
            
            try {
                console.log('[EditSession] 저장:', {
                    sessionId,
                    name,
                    originalClass: targetClassInput,
                    parsedClass,
                    instructions
                });

                const { data, error } = await supabase
                    .from('sessions')
                    .update({
                        name: name,
                        target_class: parsedClass,
                        activity_instructions: instructions
                    })
                    .eq('id', sessionId)
                    .select()
                    .single();

                if (error) throw error;

                showNotification(`세션이 성공적으로 수정되었습니다 (${parsedClass})`, 'success');
                closeEditSessionModal();
                
                // 데이터 새로고침
                await loadAllData();
                await loadTabContent(currentTab);

            } catch (error) {
                console.error('세션 수정 오류:', error);
                showNotification(`수정 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteSession(id) {
            if (!confirm('정말로 이 세션을 삭제하시겠습니까?\n관련된 모든 배정도 함께 삭제됩니다.')) {
                return;
            }

            showLoading();
            try {
                // 관련 배정들 먼저 삭제
                const { error: assignError } = await supabase
                    .from('assignments')
                    .delete()
                    .eq('session_id', id);

                if (assignError) throw assignError;

                // 세션 삭제
                const { error: sessionError } = await supabase
                    .from('sessions')
                    .delete()
                    .eq('id', id);

                if (sessionError) throw sessionError;

                showNotification('세션이 성공적으로 삭제되었습니다', 'success');
                
                // 데이터 새로고침
                await loadAllData();
                await loadTabContent(currentTab);

            } catch (error) {
                console.error('세션 삭제 오류:', error);
                showNotification(`삭제 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function showCreateSessionForm() {
            const modalHTML = `
                <div id="sessionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">새 역할 세션 생성</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- 1단계: 역할 타입 선택 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-3">
                                    <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs mr-2">1단계</span>
                                    역할 타입 선택
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button type="button" id="selectTextRole" onclick="selectRoleType('text')" 
                                            class="role-type-btn p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors">
                                        <div class="text-center">
                                            <i class="fas fa-font text-2xl text-blue-600 mb-2"></i>
                                            <div class="font-medium text-gray-900">텍스트 역할</div>
                                            <div class="text-sm text-gray-600">역할을 텍스트로 설명</div>
                                        </div>
                                    </button>
                                    <button type="button" id="selectImageRole" onclick="selectRoleType('image')" 
                                            class="role-type-btn p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                                        <div class="text-center">
                                            <i class="fas fa-image text-2xl text-green-600 mb-2"></i>
                                            <div class="font-medium text-gray-900">이미지 역할</div>
                                            <div class="text-sm text-gray-600">역할을 이미지로 표현</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 2단계: 세션 정보 (역할 타입 선택 후 활성화) -->
                            <div id="sessionInfoSection" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">세션 이름</label>
                                    <input type="text" id="sessionName" placeholder="예: 김밥 만들기 역할" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">활동방법 안내</label>
                                    <textarea id="sessionInstructions" rows="3" 
                                              placeholder="학생들에게 제공할 활동방법 안내를 입력하세요"
                                              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                
                                <!-- 텍스트 역할 입력 섹션 -->
                                <div id="textRolesSection" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">텍스트 역할 목록</label>
                                    <div id="textRolesList" class="space-y-2">
                                        <!-- 텍스트 역할들이 여기 추가됩니다 -->
                                    </div>
                                    <button type="button" onclick="addTextRole()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
                                        <i class="fas fa-plus mr-1"></i>텍스트 역할 추가
                                    </button>
                                </div>
                                
                                <!-- 이미지 역할 업로드 섹션 -->
                                <div id="imageRolesSection" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">이미지 역할 업로드</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors" 
                                         id="imageUploadArea">
                                        <div id="imageUploadPrompt">
                                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                                            <p class="text-gray-600 mb-2">이미지를 드래그하여 놓거나 클릭하여 선택하세요</p>
                                            <p class="text-sm text-gray-500">최대 20개 이미지 지원 (JPG, PNG, GIF)</p>
                                            <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
                                            <button type="button" onclick="document.getElementById('imageInput').click()" 
                                                    class="mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                                파일 선택
                                            </button>
                                        </div>
                                        <div id="imagePreviewArea" class="hidden">
                                            <div class="grid grid-cols-4 gap-3" id="imageGrid">
                                                <!-- 업로드된 이미지 미리보기가 여기 표시됩니다 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="closeSessionModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button id="createSessionBtn" onclick="createSession()" 
                                    class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" 
                                    disabled>
                                세션 생성
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 이미지 드래그 앤 드롭 이벤트 설정
            setupImageDragDrop();
        }

        // 전역 변수로 선택된 역할 타입과 업로드된 이미지들 저장
        let selectedRoleType = null;
        let uploadedImages = [];

        // 역할 타입 선택 함수
        function selectRoleType(type) {
            console.log('[SessionCreate] 역할 타입 선택:', type);
            selectedRoleType = type;
            
            // 버튼 스타일 업데이트
            document.querySelectorAll('.role-type-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'border-green-500', 'bg-blue-50', 'bg-green-50');
                btn.classList.add('border-gray-300');
            });
            
            if (type === 'text') {
                document.getElementById('selectTextRole').classList.add('border-blue-500', 'bg-blue-50');
                document.getElementById('textRolesSection').classList.remove('hidden');
                document.getElementById('imageRolesSection').classList.add('hidden');
                
                // 기본 텍스트 역할 2개 추가
                setTimeout(() => {
                    addTextRole();
                    addTextRole();
                }, 100);
            } else if (type === 'image') {
                document.getElementById('selectImageRole').classList.add('border-green-500', 'bg-green-50');
                document.getElementById('textRolesSection').classList.add('hidden');
                document.getElementById('imageRolesSection').classList.remove('hidden');
            }
            
            // 세션 정보 섹션 활성화
            document.getElementById('sessionInfoSection').classList.remove('hidden');
            document.getElementById('createSessionBtn').disabled = false;
        }

        // 텍스트 역할 추가
        function addTextRole() {
            const textRolesList = document.getElementById('textRolesList');
            const roleItem = document.createElement('div');
            roleItem.className = 'text-role-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg';
            roleItem.innerHTML = `
                <div class="flex-1">
                    <input type="text" class="role-name w-full border border-gray-300 rounded px-3 py-2" 
                           placeholder="역할 이름 (예: 김밥 재료 준비)" 
                           onkeypress="handleRoleNameEnter(event, this)">
                </div>
                <button type="button" onclick="removeTextRole(this)" class="text-red-600 hover:text-red-800 px-2">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            textRolesList.appendChild(roleItem);
        }

        // 역할 이름 입력에서 엔터키 처리
        function handleRoleNameEnter(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (input.value.trim()) {
                    addTextRole();
                    // 새로 추가된 역할의 입력란에 포커스
                    setTimeout(() => {
                        const newInputs = document.querySelectorAll('.role-name');
                        const lastInput = newInputs[newInputs.length - 1];
                        if (lastInput) {
                            lastInput.focus();
                        }
                    }, 100);
                }
            }
        }

        // 텍스트 역할 삭제
        function removeTextRole(button) {
            const roleItem = button.closest('.text-role-item');
            const textRolesList = document.getElementById('textRolesList');
            if (textRolesList.children.length > 1) {
                roleItem.remove();
            } else {
                showNotification('최소 1개의 역할은 필요합니다', 'warning');
            }
        }

        // 이미지 드래그 앤 드롭 설정
        function setupImageDragDrop() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageInput');
            
            // 파일 입력 이벤트
            fileInput.addEventListener('change', handleImageFiles);
            
            // 드래그 앤 드롭 이벤트
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-green-400', 'bg-green-50');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-green-400', 'bg-green-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-green-400', 'bg-green-50');
                const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                if (files.length > 0) {
                    handleImageFiles({ target: { files: files } });
                }
            });
        }

        // 이미지 파일 처리
        async function handleImageFiles(event) {
            const files = Array.from(event.target.files);
            const maxImages = 20;
            
            if (uploadedImages.length + files.length > maxImages) {
                showNotification(`최대 ${maxImages}개의 이미지만 업로드할 수 있습니다`, 'warning');
                return;
            }
            
            console.log('[ImageUpload] 이미지 파일 처리 시작:', files.length, '개');
            showNotification('이미지를 처리 중입니다...', 'info');
            
            for (let file of files) {
                try {
                    // 이미지 크기 확인 및 압축
                    const processedFile = await processImage(file);
                    
                    // Base64로 변환
                    const base64 = await fileToBase64(processedFile);
                    
                    uploadedImages.push({
                        name: file.name,
                        base64: base64,
                        size: processedFile.size
                    });
                } catch (error) {
                    console.error('[ImageUpload] 이미지 처리 오류:', error);
                    showNotification(`${file.name} 처리 실패`, 'error');
                }
            }
            
            updateImagePreview();
            showNotification(`${files.length}개 이미지가 업로드되었습니다`, 'success');
        }

        // 이미지 처리 (압축 등)
        async function processImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // 최대 크기 설정 (예: 800x600)
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let { width, height } = img;
                    
                    // 비율 유지하면서 크기 조정
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 압축된 이미지로 변환
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.8); // 80% 품질로 압축
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // 파일을 Base64로 변환
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 이미지 미리보기 업데이트
        function updateImagePreview() {
            const promptArea = document.getElementById('imageUploadPrompt');
            const previewArea = document.getElementById('imagePreviewArea');
            const imageGrid = document.getElementById('imageGrid');
            
            if (uploadedImages.length > 0) {
                promptArea.classList.add('hidden');
                previewArea.classList.remove('hidden');
                
                imageGrid.innerHTML = uploadedImages.map((img, index) => `
                    <div class="relative border border-gray-300 rounded-lg p-2">
                        <img src="${img.base64}" alt="${img.name}" class="w-full h-20 object-cover rounded">
                        <div class="text-xs text-gray-600 mt-1 truncate">${img.name}</div>
                        <button type="button" onclick="removeImage(${index})" 
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600">
                            ×
                        </button>
                    </div>
                `).join('');
            } else {
                promptArea.classList.remove('hidden');
                previewArea.classList.add('hidden');
            }
        }

        // 이미지 삭제
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
            showNotification('이미지가 삭제되었습니다', 'info');
        }

        // 기존 함수들 (더 이상 사용하지 않지만 호환성을 위해 유지)
        function addRole() {
            console.log('[Deprecated] addRole 함수는 더 이상 사용하지 않습니다');
        }

        function removeRole(button) {
            console.log('[Deprecated] removeRole 함수는 더 이상 사용하지 않습니다');
        }

        function closeSessionModal() {
            const modal = document.getElementById('sessionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 자유 텍스트 클래스 입력을 표준화된 형태로 파싱
        function parseTargetClass(input) {
            if (!input || !input.trim()) {
                return null;
            }
            
            const trimmed = input.trim();
            console.log('[ClassParser] 입력:', trimmed);
            
            // 패턴 매칭
            // "3-1", "3학년 1반" → "3학년 1반"
            const gradeClassPattern = /^(\d+)[-\s]*(\d+)$|^(\d+)학년\s*(\d+)반$/;
            const gradeClassMatch = trimmed.match(gradeClassPattern);
            
            if (gradeClassMatch) {
                const grade = gradeClassMatch[1] || gradeClassMatch[3];
                const classNum = gradeClassMatch[2] || gradeClassMatch[4];
                const result = `${grade}학년 ${classNum}반`;
                console.log('[ClassParser] 학급 매칭:', result);
                return result;
            }
            
            // "4학년", "3학년" → "4학년 전체"
            const gradeOnlyPattern = /^(\d+)학년?$/;
            const gradeOnlyMatch = trimmed.match(gradeOnlyPattern);
            
            if (gradeOnlyMatch) {
                const grade = gradeOnlyMatch[1];
                const result = `${grade}학년 전체`;
                console.log('[ClassParser] 학년 매칭:', result);
                return result;
            }
            
            // "전체", "모든학년", "전학년" → "전체"
            if (/^(전체|모든학년|전학년|전교)$/.test(trimmed)) {
                console.log('[ClassParser] 전체 매칭: 전체');
                return '전체';
            }
            
            // 매칭되지 않은 경우 원본 그대로 반환
            console.log('[ClassParser] 직접 사용:', trimmed);
            return trimmed;
        }

        async function createSession() {
            const name = document.getElementById('sessionName').value.trim();
            const instructions = document.getElementById('sessionInstructions').value.trim();
            
            if (!name) {
                showNotification('세션 이름을 입력하세요', 'error');
                return;
            }

            let roles = [];
            
            // 텍스트 역할 처리
            if (selectedRoleType === 'text') {
                const textRoleItems = document.querySelectorAll('.text-role-item');
                
                for (let i = 0; i < textRoleItems.length; i++) {
                    const item = textRoleItems[i];
                    const roleName = item.querySelector('.role-name').value.trim();
                    
                    if (roleName) {
                        roles.push({
                            id: `role_${Date.now()}_${i}`,
                            name: roleName,
                            type: 'text',
                            content: roleName // 역할 설명 대신 이름을 content로 사용
                        });
                    }
                }
            } 
            // 이미지 역할 처리
            else if (selectedRoleType === 'image') {
                for (let i = 0; i < uploadedImages.length; i++) {
                    const img = uploadedImages[i];
                    roles.push({
                        id: `role_${Date.now()}_${i}`,
                        name: img.name,
                        type: 'image',
                        content: img.base64
                    });
                }
            }
            
            if (roles.length === 0) {
                showNotification('최소 1개의 역할을 입력하세요', 'error');
                return;
            }

            showLoading();
            
            try {
                console.log('[SessionCreate] 세션 데이터:', {
                    name,
                    roleType: selectedRoleType,
                    rolesCount: roles.length
                });

                const sessionData = {
                    name: name,
                    type: 'role_assignment',
                    missions: JSON.stringify(roles),
                    activity_instructions: instructions,
                    status: 'active'
                };

                const { data, error } = await supabase
                    .from('sessions')
                    .insert([sessionData])
                    .select()
                    .single();

                if (error) throw error;

                showNotification('세션이 성공적으로 생성되었습니다', 'success');
                closeSessionModal();
                
                // 전역 변수 초기화
                selectedRoleType = null;
                uploadedImages = [];
                
                // 데이터 새로고침
                await loadAllData();
                await loadTabContent(currentTab);

            } catch (error) {
                console.error('세션 생성 오류:', error);
                showNotification(`세션 생성 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function refreshStatus() {
            loadAllData().then(() => {
                loadTabContent(currentTab);
                showNotification('데이터가 새로고침되었습니다', 'success');
            });
        }

        function exportAssignments() {
            showNotification('CSV 내보내기 기능은 다음 단계에서 구현됩니다', 'info');
        }

        // 대량 배정 관련 함수들
        function closeBulkAssignModal() {
            const modal = document.getElementById('bulkAssignModal');
            if (modal) {
                modal.remove();
            }
        }

        async function onBulkSessionChange() {
            const sessionSelect = document.getElementById('bulkSessionSelect');
            const selectedSessionId = sessionSelect.value;
            
            if (!selectedSessionId) {
                // 선택 해제시 섹션들 숨기기
                document.getElementById('targetClassSection').classList.add('hidden');
                document.getElementById('assignmentOptionsSection').classList.add('hidden');
                document.getElementById('previewSection').classList.add('hidden');
                document.getElementById('previewButton').disabled = true;
                document.getElementById('executeButton').disabled = true;
                return;
            }

            const session = sessions.find(s => s.id === selectedSessionId);
            if (!session) return;

            console.log('[BulkAssign] 세션 선택됨:', session.name);

            // 대상 학급 정보 표시
            const targetClass = session.target_class;
            const classStudents = students.filter(s => s.class_name === targetClass);
            
            document.getElementById('targetClassInfo').innerHTML = `
                <div class="bg-green-50 rounded p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-green-900">${targetClass}</div>
                            <div class="text-sm text-green-700">총 ${classStudents.length}명의 학생</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-green-600">
                                역할 수: ${JSON.parse(session.missions || '[]').length}개
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 기존 배정 확인
            const existingAssignments = assignments.filter(a => a.session_id === selectedSessionId);
            if (existingAssignments.length > 0) {
                document.getElementById('targetClassInfo').innerHTML += `
                    <div class="mt-2 p-2 bg-yellow-50 rounded text-sm">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-1"></i>
                        <span class="text-yellow-800">이미 ${existingAssignments.length}명에게 배정되었습니다</span>
                    </div>
                `;
                document.getElementById('replaceExisting').checked = false;
            }

            // 섹션들 표시
            document.getElementById('targetClassSection').classList.remove('hidden');
            document.getElementById('assignmentOptionsSection').classList.remove('hidden');
            document.getElementById('previewButton').disabled = false;

            // 미리보기 자동 생성
            setTimeout(() => {
                generatePreview();
            }, 500);
        }

        async function generatePreview() {
            console.log('[BulkAssign] 배정 미리보기 생성');
            
            const sessionSelect = document.getElementById('bulkSessionSelect');
            const selectedSessionId = sessionSelect.value;
            const replaceExisting = document.getElementById('replaceExisting').checked;
            const assignmentMethod = document.querySelector('input[name="assignmentMethod"]:checked').value;

            if (!selectedSessionId) {
                showNotification('세션을 먼저 선택하세요', 'warning');
                return;
            }

            const session = sessions.find(s => s.id === selectedSessionId);
            const targetClass = session.target_class;
            const classStudents = students.filter(s => s.class_name === targetClass);
            const roles = JSON.parse(session.missions || '[]');
            
            if (classStudents.length === 0) {
                showNotification(`${targetClass} 학생이 없습니다`, 'warning');
                return;
            }

            if (roles.length === 0) {
                showNotification('세션에 역할이 없습니다', 'warning');
                return;
            }

            // 기존 배정 확인
            const existingAssignments = assignments.filter(a => a.session_id === selectedSessionId);
            let studentsToAssign = classStudents;

            if (!replaceExisting && existingAssignments.length > 0) {
                const assignedStudentIds = new Set(existingAssignments.map(a => a.student_id));
                studentsToAssign = classStudents.filter(s => !assignedStudentIds.has(s.id));
            }

            if (studentsToAssign.length === 0) {
                document.getElementById('assignmentPreview').innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-check-circle text-2xl mb-2"></i>
                        <div>모든 학생에게 이미 배정되었습니다</div>
                        <div class="text-sm">기존 배정 교체 옵션을 확인하세요</div>
                    </div>
                `;
                document.getElementById('previewSection').classList.remove('hidden');
                document.getElementById('executeButton').disabled = true;
                return;
            }

            // 배정 시뮬레이션
            let assignments = [];
            
            switch (assignmentMethod) {
                case 'random':
                    assignments = generateRandomAssignments(studentsToAssign, roles);
                    break;
                case 'sequential':
                    assignments = generateSequentialAssignments(studentsToAssign, roles);
                    break;
                case 'manual':
                    showNotification('개별 지정은 다음 단계에서 구현됩니다', 'info');
                    return;
            }

            // 미리보기 표시
            const previewHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-medium">배정될 학생: ${assignments.length}명</span>
                        <span class="text-gray-500">방식: ${getAssignmentMethodName(assignmentMethod)}</span>
                    </div>
                    
                    <div class="max-h-48 overflow-y-auto border border-gray-200 rounded">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left">학생</th>
                                    <th class="px-3 py-2 text-left">배정될 역할</th>
                                    <th class="px-3 py-2 text-left">상태</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${assignments.map(a => `
                                    <tr class="border-t">
                                        <td class="px-3 py-2">${a.student_name}</td>
                                        <td class="px-3 py-2">
                                            <span class="font-medium">${a.role_name}</span>
                                            <div class="text-xs text-gray-500">${a.role_description}</div>
                                        </td>
                                        <td class="px-3 py-2">
                                            ${a.isReplacement ? 
                                                '<span class="text-yellow-600 text-xs">교체</span>' : 
                                                '<span class="text-green-600 text-xs">신규</span>'
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('assignmentPreview').innerHTML = previewHTML;
            document.getElementById('previewSection').classList.remove('hidden');
            document.getElementById('executeButton').disabled = false;

            // 전역 변수에 저장 (실행시 사용)
            window.currentAssignmentPreview = assignments;
        }

        function generateRandomAssignments(students, roles) {
            const assignments = [];
            const shuffledStudents = [...students].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < shuffledStudents.length; i++) {
                const student = shuffledStudents[i];
                const role = roles[i % roles.length]; // 역할이 학생보다 적으면 순환
                
                assignments.push({
                    student_id: student.id,
                    student_name: student.name,
                    role_id: role.id,
                    role_name: role.name,
                    role_description: role.content,
                    role_type: role.type,
                    isReplacement: false
                });
            }
            
            return assignments;
        }

        function generateSequentialAssignments(students, roles) {
            const assignments = [];
            
            for (let i = 0; i < students.length; i++) {
                const student = students[i];
                const role = roles[i % roles.length];
                
                assignments.push({
                    student_id: student.id,
                    student_name: student.name,
                    role_id: role.id,
                    role_name: role.name,
                    role_description: role.content,
                    role_type: role.type,
                    isReplacement: false
                });
            }
            
            return assignments;
        }

        function getAssignmentMethodName(method) {
            const names = {
                'random': '무작위 배정',
                'sequential': '순차 배정', 
                'manual': '개별 지정'
            };
            return names[method] || method;
        }

        async function executeBulkAssignment() {
            console.log('[BulkAssign] 일괄 배정 실행');
            
            if (!window.currentAssignmentPreview || window.currentAssignmentPreview.length === 0) {
                showNotification('먼저 미리보기를 생성하세요', 'warning');
                return;
            }

            if (!confirm(`${window.currentAssignmentPreview.length}명의 학생에게 역할을 배정하시겠습니까?`)) {
                return;
            }

            showLoading();
            
            try {
                const sessionSelect = document.getElementById('bulkSessionSelect');
                const selectedSessionId = sessionSelect.value;
                const session = sessions.find(s => s.id === selectedSessionId);
                const replaceExisting = document.getElementById('replaceExisting').checked;

                // 기존 배정 삭제 (교체 옵션이 켜진 경우)
                if (replaceExisting) {
                    const { error: deleteError } = await supabase
                        .from('assignments')
                        .delete()
                        .eq('session_id', selectedSessionId);
                    
                    if (deleteError) throw deleteError;
                }

                // 새로운 배정들 생성
                const assignmentData = window.currentAssignmentPreview.map(a => ({
                    student_id: a.student_id,
                    student_name: a.student_name,
                    session_id: selectedSessionId,
                    session_name: session.name,
                    role_id: a.role_id,
                    role_name: a.role_name,
                    role_description: a.role_description,
                    role_type: a.role_type,
                    assigned_at: new Date().toISOString()
                }));

                const { data, error } = await supabase
                    .from('assignments')
                    .insert(assignmentData)
                    .select();

                if (error) throw error;

                showNotification(`성공적으로 ${assignmentData.length}명에게 역할을 배정했습니다!`, 'success');
                closeBulkAssignModal();
                
                // 데이터 새로고침
                await loadAllData();
                await loadTabContent(currentTab);

                // 배정 탭으로 자동 전환
                setTimeout(() => {
                    switchTab('status');
                }, 1000);

            } catch (error) {
                console.error('일괄 배정 오류:', error);
                showNotification(`배정 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // 개별 배정 관리 함수들
        async function editSingleAssignment(assignmentId) {
            console.log('[Assignment] 개별 배정 편집:', assignmentId);
            
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) {
                showNotification('배정을 찾을 수 없습니다', 'error');
                return;
            }

            const session = sessions.find(s => s.id === assignment.session_id);
            const roles = JSON.parse(session.missions || '[]');

            const modalHTML = `
                <div id="editAssignmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-lg w-full">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">
                                <i class="fas fa-edit mr-2 text-indigo-600"></i>
                                배정 편집
                            </h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">학생</label>
                                <input type="text" value="${assignment.student_name}" readonly 
                                       class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">세션</label>
                                <input type="text" value="${assignment.session_name}" readonly 
                                       class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">새 역할 선택</label>
                                <select id="editRoleSelect" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${roles.map(role => `
                                        <option value="${role.id}" 
                                                data-name="${role.name}" 
                                                data-content="${role.content}" 
                                                data-type="${role.type}"
                                                ${role.id === assignment.role_id ? 'selected' : ''}>
                                            ${role.name} - ${role.content}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="closeEditAssignmentModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button onclick="updateAssignment('${assignmentId}')" 
                                    class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-save mr-1"></i>저장
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditAssignmentModal() {
            const modal = document.getElementById('editAssignmentModal');
            if (modal) {
                modal.remove();
            }
        }

        async function updateAssignment(assignmentId) {
            const roleSelect = document.getElementById('editRoleSelect');
            const selectedOption = roleSelect.selectedOptions[0];
            
            if (!selectedOption) {
                showNotification('역할을 선택하세요', 'warning');
                return;
            }

            showLoading();
            
            try {
                const updateData = {
                    role_id: selectedOption.value,
                    role_name: selectedOption.dataset.name,
                    role_description: selectedOption.dataset.content,
                    role_type: selectedOption.dataset.type
                };

                const { data, error } = await supabase
                    .from('assignments')
                    .update(updateData)
                    .eq('id', assignmentId)
                    .select()
                    .single();

                if (error) throw error;

                showNotification('배정이 성공적으로 수정되었습니다', 'success');
                closeEditAssignmentModal();
                
                // 데이터 새로고침
                await loadAllData();
                await refreshAssignmentDetails();

            } catch (error) {
                console.error('배정 수정 오류:', error);
                showNotification(`수정 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteSingleAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) {
                showNotification('배정을 찾을 수 없습니다', 'error');
                return;
            }

            if (!confirm(`${assignment.student_name}의 배정을 삭제하시겠습니까?`)) {
                return;
            }

            showLoading();
            
            try {
                const { error } = await supabase
                    .from('assignments')
                    .delete()
                    .eq('id', assignmentId);

                if (error) throw error;

                showNotification('배정이 삭제되었습니다', 'success');
                
                // 데이터 새로고침
                await loadAllData();
                await refreshAssignmentDetails();

            } catch (error) {
                console.error('배정 삭제 오류:', error);
                showNotification(`삭제 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function assignSingleStudent(studentId, sessionId) {
            console.log('[Assignment] 개별 학생 배정:', studentId, sessionId);
            
            const student = students.find(s => s.id === studentId);
            const session = sessions.find(s => s.id === sessionId);
            
            if (!student || !session) {
                showNotification('학생 또는 세션을 찾을 수 없습니다', 'error');
                return;
            }

            const roles = JSON.parse(session.missions || '[]');
            if (roles.length === 0) {
                showNotification('세션에 역할이 없습니다', 'warning');
                return;
            }

            const modalHTML = `
                <div id="singleAssignModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-lg w-full">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">
                                <i class="fas fa-user-plus mr-2 text-green-600"></i>
                                개별 역할 배정
                            </h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">학생</label>
                                <input type="text" value="${student.name} (${student.class_name})" readonly 
                                       class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">세션</label>
                                <input type="text" value="${session.name}" readonly 
                                       class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">역할 선택</label>
                                <select id="singleRoleSelect" class="w-full border border-gray-300 rounded px-3 py-2">
                                    <option value="">역할을 선택하세요</option>
                                    ${roles.map(role => `
                                        <option value="${role.id}" 
                                                data-name="${role.name}" 
                                                data-content="${role.content}" 
                                                data-type="${role.type}">
                                            ${role.name} - ${role.content}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="closeSingleAssignModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button onclick="executeSingleAssignment('${studentId}', '${sessionId}')" 
                                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                <i class="fas fa-check mr-1"></i>배정
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeSingleAssignModal() {
            const modal = document.getElementById('singleAssignModal');
            if (modal) {
                modal.remove();
            }
        }

        async function executeSingleAssignment(studentId, sessionId) {
            const roleSelect = document.getElementById('singleRoleSelect');
            const selectedOption = roleSelect.selectedOptions[0];
            
            if (!selectedOption) {
                showNotification('역할을 선택하세요', 'warning');
                return;
            }

            const student = students.find(s => s.id === studentId);
            const session = sessions.find(s => s.id === sessionId);

            showLoading();
            
            try {
                const assignmentData = {
                    student_id: studentId,
                    student_name: student.name,
                    session_id: sessionId,
                    session_name: session.name,
                    role_id: selectedOption.value,
                    role_name: selectedOption.dataset.name,
                    role_description: selectedOption.dataset.content,
                    role_type: selectedOption.dataset.type,
                    assigned_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('assignments')
                    .insert([assignmentData])
                    .select()
                    .single();

                if (error) throw error;

                showNotification(`${student.name}에게 역할이 배정되었습니다`, 'success');
                closeSingleAssignModal();
                
                // 데이터 새로고침
                await loadAllData();
                await refreshAssignmentDetails();

            } catch (error) {
                console.error('개별 배정 오류:', error);
                showNotification(`배정 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function editSelectedAssignments() {
            const checkedBoxes = document.querySelectorAll('.assignment-checkbox:checked');
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showNotification('편집할 배정을 선택하세요', 'warning');
                return;
            }

            // 다중 편집은 다음 단계에서 구현
            showNotification(`선택된 ${selectedIds.length}개 배정의 일괄 편집은 다음 단계에서 구현됩니다`, 'info');
        }

        // Step 3: 단순화된 배정 함수들
        async function quickRandomAssign(sessionId) {
            console.log('[QuickAssign] 세션 빠른 랜덤 배정:', sessionId);
            
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                showNotification('세션을 찾을 수 없습니다', 'error');
                return;
            }

            const targetClass = session.target_class;
            const roles = JSON.parse(session.missions || '[]');
            
            if (roles.length === 0) {
                showNotification('세션에 역할이 없습니다', 'error');
                return;
            }

            // 대상 학생들 찾기 (로그인 상태 무관하게 전체 학생 대상)
            let targetStudents = [];
            
            if (targetClass === '전체') {
                targetStudents = students; // 전체 학생
            } else if (targetClass.includes('학년 전체')) {
                const grade = targetClass.replace('학년 전체', '');
                targetStudents = students.filter(s => s.class_name && s.class_name.startsWith(grade + '학년'));
            } else {
                targetStudents = students.filter(s => s.class_name === targetClass);
            }
            
            if (targetStudents.length === 0) {
                showNotification(`${targetClass} 학생이 없습니다`, 'warning');
                return;
            }

            // 기존 배정 확인
            const existingAssignments = assignments.filter(a => a.session_id === sessionId);
            
            let confirmMessage = `${session.name} 세션에 ${targetStudents.length}명의 학생을 랜덤으로 배정하시겠습니까?`;
            if (existingAssignments.length > 0) {
                confirmMessage = `기존 배정 ${existingAssignments.length}개가 있습니다. 모두 삭제하고 ${targetStudents.length}명을 새로 배정하시겠습니까?`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading();
            
            try {
                // 기존 배정 삭제 (있는 경우)
                if (existingAssignments.length > 0) {
                    const { error: deleteError } = await supabase
                        .from('assignments')
                        .delete()
                        .eq('session_id', sessionId);
                    
                    if (deleteError) throw deleteError;
                }

                // 랜덤 배정 생성
                const randomAssignments = generateRandomAssignments(targetStudents, roles);
                
                // 배정 데이터 준비
                const assignmentData = randomAssignments.map(a => ({
                    student_id: a.student_id,
                    student_name: a.student_name,
                    session_id: sessionId,
                    session_name: session.name,
                    role_id: a.role_id,
                    role_name: a.role_name,
                    role_description: a.role_description,
                    role_type: a.role_type,
                    assigned_at: new Date().toISOString()
                }));

                // 데이터베이스에 저장
                const { data, error } = await supabase
                    .from('assignments')
                    .insert(assignmentData)
                    .select();

                if (error) throw error;

                showNotification(`성공! ${targetStudents.length}명에게 랜덤 배정 완료`, 'success');
                
                // 데이터 새로고침
                await loadAllData();
                await loadTabContent(currentTab);

                // 배정 상태 탭으로 자동 전환
                setTimeout(() => {
                    switchTab('status');
                }, 1000);

            } catch (error) {
                console.error('랜덤 배정 오류:', error);
                showNotification(`배정 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // 유틸리티 함수들
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // 새로운 배정 관리 시스템 함수들
        let currentAssignmentSession = null;
        let currentAssignments = [];

        // 배정용 세션 선택
        function selectAssignmentSession() {
            const select = document.getElementById('assignmentSessionSelect');
            const selectedValue = select.value;
            
            if (selectedValue) {
                currentAssignmentSession = sessions.find(s => s.id == selectedValue);
                document.getElementById('targetClassSection').classList.remove('hidden');
                console.log('[Assignment] 세션 선택:', currentAssignmentSession.name);
            } else {
                currentAssignmentSession = null;
                document.getElementById('targetClassSection').classList.add('hidden');
                document.getElementById('assignmentResultSection').classList.add('hidden');
            }
        }

        // 배정 시작 - 4자리 학번 시스템 적용
        async function startAssignment() {
            const targetClassInput = document.getElementById('assignmentTargetClass').value.trim();
            
            if (!currentAssignmentSession) {
                showNotification('세션을 선택하세요', 'error');
                return;
            }
            
            if (!targetClassInput) {
                showNotification('대상 학급을 입력하세요', 'error');
                return;
            }

            // 클래스 파싱
            const parsedClass = parseTargetClass(targetClassInput);
            if (!parsedClass) {
                showNotification('대상 학급 형식이 올바르지 않습니다', 'error');
                return;
            }

            console.log('[Assignment] 배정 시작:', parsedClass, currentAssignmentSession.name);
            
            try {
                // 세션의 역할 목록 가져오기
                const roles = JSON.parse(currentAssignmentSession.missions);
                
                // 4자리 학번 시스템으로 학생 ID 생성
                const assignments = [];
                
                // 학급 정보에서 학년과 반 추출
                let grade, classNum;
                if (parsedClass.match(/^(\d+)학년 (\d+)반$/)) {
                    const matches = parsedClass.match(/^(\d+)학년 (\d+)반$/);
                    grade = parseInt(matches[1]);
                    classNum = parseInt(matches[2]);
                } else if (parsedClass.match(/^(\d+)학년/)) {
                    const matches = parsedClass.match(/^(\d+)학년/);
                    grade = parseInt(matches[1]);
                    classNum = 1; // 기본적으로 1반으로 설정
                } else {
                    showNotification('학급 형식을 인식할 수 없습니다. 예: "3-1" 또는 "3학년 1반"', 'error');
                    return;
                }
                
                console.log(`[Assignment] 추출된 학급 정보: ${grade}학년 ${classNum}반`);
                
                // 1~27번 학생에게 4자리 학번으로 배정
                for (let studentNum = 1; studentNum <= 27; studentNum++) {
                    // 4자리 학번 생성: 학년 + 반 + 학생번호(2자리)
                    const studentNumber = studentNum.toString().padStart(2, '0'); // 01, 02, 03, ...
                    const fourDigitId = `${grade}${classNum}${studentNumber}`; // 예: 3102, 3103, 3104, ...
                    
                    const randomRole = roles[Math.floor(Math.random() * roles.length)];
                    assignments.push({
                        student_number: fourDigitId,  // 4자리 학번 사용
                        student_name: `${fourDigitId}번`,
                        role_id: randomRole.id,
                        role_name: randomRole.name,
                        role_content: randomRole.content,
                        role_type: randomRole.type,
                        original_index: studentNum  // 원래 순서 보존
                    });
                }
                
                currentAssignments = assignments;
                displayAssignmentResults(parsedClass);
                
                console.log(`[Assignment] ${grade}학년 ${classNum}반에 4자리 학번으로 ${assignments.length}명 배정 완료`);
                
            } catch (error) {
                console.error('배정 오류:', error);
                showNotification(`배정 실패: ${error.message}`, 'error');
            }
        }

        // 배정 결과 표시
        function displayAssignmentResults(targetClass) {
            const resultSection = document.getElementById('assignmentResultSection');
            const assignmentGrid = document.getElementById('assignmentGrid');
            
            resultSection.classList.remove('hidden');
            
            assignmentGrid.innerHTML = currentAssignments.map(assignment => `
                <div class="border border-gray-200 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm font-semibold text-gray-900">${assignment.student_name}</div>
                        <button onclick="editStudentAssignment('${assignment.student_number}')" 
                                class="text-blue-600 hover:text-blue-800 text-xs">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700 font-medium">${assignment.role_name}</div>
                    ${assignment.role_type === 'text' 
                        ? `<div class="text-xs text-gray-600 mt-1">${assignment.role_content}</div>`
                        : `<div class="text-xs text-gray-600 mt-1">
                             <i class="fas fa-image mr-1"></i>이미지 역할
                           </div>`
                    }
                </div>
            `).join('');
            
            showNotification(`${targetClass}에 ${currentAssignments.length}명 배정 완료 (4자리 학번 적용)`, 'success');
        }

        // 재배정 (셔플)
        function shuffleAssignments() {
            if (!currentAssignmentSession || currentAssignments.length === 0) return;
            
            const roles = JSON.parse(currentAssignmentSession.missions);
            
            // 기존 배정을 셔플
            for (let i = 0; i < currentAssignments.length; i++) {
                const randomRole = roles[Math.floor(Math.random() * roles.length)];
                currentAssignments[i].role_id = randomRole.id;
                currentAssignments[i].role_name = randomRole.name;
                currentAssignments[i].role_content = randomRole.content;
                currentAssignments[i].role_type = randomRole.type;
            }
            
            // 결과 다시 표시
            const assignmentGrid = document.getElementById('assignmentGrid');
            assignmentGrid.innerHTML = currentAssignments.map(assignment => `
                <div class="border border-gray-200 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm font-semibold text-gray-900">${assignment.student_name}</div>
                        <button onclick="editStudentAssignment(${assignment.student_number})" 
                                class="text-blue-600 hover:text-blue-800 text-xs">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700 font-medium">${assignment.role_name}</div>
                    ${assignment.role_type === 'text' 
                        ? `<div class="text-xs text-gray-600 mt-1">${assignment.role_content}</div>`
                        : `<div class="text-xs text-gray-600 mt-1">
                             <i class="fas fa-image mr-1"></i>이미지 역할
                           </div>`
                    }
                </div>
            `).join('');
            
            showNotification('역할이 재배정되었습니다', 'info');
        }

        // 개별 학생 배정 수정
        function editStudentAssignment(studentNumber) {
            const assignment = currentAssignments.find(a => a.student_number === studentNumber);
            if (!assignment || !currentAssignmentSession) return;
            
            const roles = JSON.parse(currentAssignmentSession.missions);
            
            const modalHTML = `
                <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-md w-full">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">${assignment.student_name} 역할 수정</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">현재 역할</label>
                                <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">${assignment.role_name}</div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">새 역할 선택</label>
                                <select id="newRoleSelect" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${roles.map(role => `
                                        <option value="${role.id}" 
                                                data-name="${role.name}" 
                                                data-content="${role.content}" 
                                                data-type="${role.type}"
                                                ${role.id === assignment.role_id ? 'selected' : ''}>
                                            ${role.name}${role.type === 'text' ? ' - ' + role.content : ' (이미지)'}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="closeEditStudentModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button onclick="updateStudentAssignment('${studentNumber}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                저장
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditStudentModal() {
            const modal = document.getElementById('editStudentModal');
            if (modal) modal.remove();
        }

        function updateStudentAssignment(studentNumber) {
            const select = document.getElementById('newRoleSelect');
            const selectedOption = select.selectedOptions[0];
            
            if (!selectedOption) {
                showNotification('역할을 선택하세요', 'error');
                return;
            }
            
            const assignment = currentAssignments.find(a => a.student_number === studentNumber);
            if (assignment) {
                assignment.role_id = selectedOption.value;
                assignment.role_name = selectedOption.dataset.name;
                assignment.role_content = selectedOption.dataset.content;
                assignment.role_type = selectedOption.dataset.type;
                
                // 화면 업데이트
                displayAssignmentResults(document.getElementById('assignmentTargetClass').value.trim());
                closeEditStudentModal();
                showNotification(`${assignment.student_name} 역할이 변경되었습니다`, 'success');
            }
        }

        // 배정 저장
        async function saveAssignments() {
            if (!currentAssignmentSession || currentAssignments.length === 0) {
                showNotification('저장할 배정이 없습니다', 'error');
                return;
            }
            
            const targetClass = parseTargetClass(document.getElementById('assignmentTargetClass').value.trim());
            
            showLoading();
            
            try {
                // 기존 배정 삭제 (동일 세션, 동일 학급)
                await supabase
                    .from('assignments')
                    .delete()
                    .eq('session_id', currentAssignmentSession.id)
                    .eq('target_class', targetClass);
                
                // 새 배정 데이터 준비 - 4자리 학번 시스템 적용
                const assignmentData = currentAssignments.map(assignment => ({
                    session_id: currentAssignmentSession.id,
                    session_name: currentAssignmentSession.name,
                    student_id: assignment.student_number.toString(), // 이미 4자리 학번
                    student_name: assignment.student_name,
                    target_class: targetClass,
                    role_name: assignment.role_name,
                    role_content: assignment.role_content,
                    role_type: assignment.role_type,
                    role_index: assignment.original_index || assignment.student_number, // 원래 순서 또는 4자리 학번
                    auto_assigned: true,
                    assigned_at: new Date().toISOString()
                }));
                
                // 배정 데이터 삽입
                const { error } = await supabase
                    .from('assignments')
                    .insert(assignmentData);
                
                if (error) throw error;
                
                showNotification(`${targetClass}에 ${currentAssignments.length}명 배정이 저장되었습니다`, 'success');
                
                // 데이터 새로고침
                await loadAllData();
                
            } catch (error) {
                console.error('배정 저장 오류:', error);
                showNotification(`배정 저장 실패: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>